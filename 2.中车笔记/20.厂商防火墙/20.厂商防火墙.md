# 防火墙

## 01.基础知识

### 什么是防火墙

网络防火墙是一种用来加强网络之间访问控制的特殊网络互联设备。计算机流入流出的所有网络通信均要经过此防火墙。防火墙对流经它的网络通信进行扫描，这样能够过滤掉一些攻击，以免其在目标计算机上被执行。防火墙还可以关闭不使用的端口。而且它还能禁止特定端口的流出通信，封锁木马。最后，它可以禁止来自特殊站点的访问，从而防止来自不明入侵者的所有通信。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙0.png)

防火墙就是在两个信任程度不同的网络之间设置的、用于加强访问控制的软硬件保护措施。防火墙能够强化安全策略，限制用户暴露点，是一个安全策略检查站。

除去上面的优点防火墙也具有一定的局限性。防火墙防外而不防内；管理和配置复杂度较高，如果配置不当容易导致安全漏洞；且很难为用户在防火墙内外提供一致的安全策略；是一种粗粒度的访问控制。

### 防火墙的发展简史

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙1.png)

如上图，第一代防火墙是采用包过滤技术，随后在 1989 年推出了电路层防火墙和应用层防火墙的初步结构，诞生了第二代、第三代防火墙。第四代防火墙产生于 1992 年，开发出了基于动态包过滤技术的防火墙。1998 年，NAI 公司推出一种自适应代理技术，可以称之为第五代防火墙。

2000 年后的一体化安全网关 UTM（Universal Threat Management，统一威胁管理），整合了防火墙、入侵检测、入侵保护、防病毒、防垃圾邮件等综合功能。随后是新一代的应用层防火墙，又可以称为 IPS：入侵保护，包括病毒防火墙、Web 防火墙、VoIP 防火墙等等。

下一代防火墙（Next\-Generation Firewall，简称NGFW）是在传统防火墙基础上发展而来的一种新型网络安全设备。它在维护网络安全性和过滤恶意流量方面有着更高效、更智能的特点。

#### 防火墙的分类

防火墙主要由服务访问规则、验证工具、包过滤和应用网关4个部分组成。依照不同的角度，防火墙有很多种分类方式，以下是比较常见的六种：

1、按软、硬件形式的不同，防火墙分为软件防火墙、硬件防火墙和芯片级防火墙。

2、按所利用技术不同，可分为网络层防火墙、分组过滤型防火墙、电路级网关、规则检查防火墙、应用层防火墙和复合型防火墙。

3、按防火墙结构不同，可分为单主机防火墙、路由器集成式防火墙和分布式防火墙。

4、按防火墙的应用部署位置不同，可分为边界防火墙、个人防火墙和混合防火墙。

5、按防火墙的性能的不同，可分为百兆级防火墙和千兆级防火墙等。

6、按防火墙使用范围不同，可分为个人防火墙和网络防火墙。

## 02.防火墙技术原理

### 包过滤技术

包过滤技术检查数据包的报头信息，依照过滤规则进行过滤，其检查的典型报头信息内容如下：

（1）IP 数据报的源 IP 地址、目的 IP 地址、协议类型，选项字段等。

（2）TCP 数据包的源端口、目标端口、标志段等。

（3）UDP 数据包的源端口、目标端口。

（4）ICMP 类型。

包过滤技术不需要内部网络用户做任何配置，对用户来说是完全透明的，过滤速度快，效率高。但不能进行数据内容级别的访问控制，一些应用协议也并不适合用数据报过滤，并且过滤规则的配置比较复杂，容易产生冲突和漏洞。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙2.png)

### 状态检测技术

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙3.png)

从收到的数据包中提取状态信息，并根据状态表进行判断，如果该包属于已建立的连接状态，则跳过包过滤的规则检测直接交由内网主机，如果不是已建立的连接状态则对其进行包过滤，依照规则进行操作。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙4.png)

在状态检测技术中，状态表是动态建立的，可以实现对一些复杂协议建立的临时端口进行有效的管理，状态检测技术为每一个会话连接建立状态信息，并对其维护，利用这些状态信息对数据包进行过滤。动态状态表是状态检测防火墙的核心，利用其可以实现比包过滤防火墙更强的控制访问能力。

状态检测技术的缺点是没有对数据包内容进行检测，不能进行数据内容级别的控制。由于允许外网主机与内网主机直接连接，增加了内网主机被外部攻击者直接攻击的风险。

### 代理服务技术

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙5.png)

当接收到客户端发出的连接请求后，应用代理检查客户的源和目的 IP 地址，并依据事先设定的过滤规则决定是否允许该连接请求。如果允许该连接请求，进行客户身份识别。否则，则阻断该连接请求。通过身份识别后，应用代理建立该连接请求的连接，并根据过滤规则传递和过滤该连接之间的通信数据。当关闭连接后，应用代理关闭对应的另一方连接，并将这次的连接记录在日志内。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙6.png)

应用级代理的优点是内部网络的拓扑、IP 地址等被代理防火墙屏蔽，能有效实现内外网络的隔离。具有强鉴别和细粒度日志能力，支持用户身份识别，实现用户级的安全。能进行数据内容的检查，实现基于内容的过滤，对通信进行严密的监控。

代理服务的额外处理请求降低了过滤性能，导致其过滤速度比包过滤器处理速度慢。并且需要为每一种应用服务编写代理软件模块，提供的服务数目有限。对操作系统的依赖程度高，容易因操作系统和应用软件的缺陷而受到攻击。

### 安全策略

每一条安全策略都是由匹配条件和动作组成的规则。防火墙接收到报文以后，将报文的属性与安全策略的匹配条件进行匹配。如果所有条件都匹配，则此报文成功匹配安全策略，防火墙按照该安全策略的动作处理这个报文及其后续双向流量。因此，安全策略的核心元素是匹配条件和动作。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙7.png)

#### 匹配条件

安全策略的匹配条件描述了流量的特征，用于筛选出符合条件的流量。安全策略的匹配条件包括以下要素。

<span style="color:#FF0000">谁</span> ：谁发出的流量，即用户。在单点登录场景下，还可以指定用户的接入方式、用户使用的终端设备类型。

<span style="color:#FF0000">从哪里来，到哪里去</span> ：流量的来源和目的，包括源/目的安全区域、源/目的IP地址、源/目的地区和VLAN。地区本质上是IP地址在地理区域上的映射。

<span style="color:#FF0000">干什么</span> ：访问的服务、应用或者URL分类。

<span style="color:#FF0000">什么时候</span> ：即时间段。

以上匹配条件，在一条安全策略中都是可选配置；但是一旦配置了，就必须全部符合才认为匹配，即这些匹配条件之间是“与”的关系。一个匹配条件中如果配置了多个值，多个值之间是“或”的关系，只要流量匹配了其中任意一个值，就认为匹配了这个条件。

一条安全策略中的匹配条件越具体，其所描述的流量越精确。你可以只使用五元组（源/目的IP地址、端口、协议）作为匹配条件，也可以利用防火墙的应用识别、用户识别能力，更精确、更方便地配置安全策略。

#### 动作

安全策略的基本动作有两个：允许和禁止，即流量能否通过。

如果动作为 <span style="color:#FF0000">允许</span> ，你还可以对此符合此策略的流量执行进一步的内容安全检查。防火墙的内容安全检查功能包括反病毒AV、入侵防御IPS、URL过滤、文件过滤、内容过滤、应用行为控制、邮件过滤、APT防御、DNS过滤等。每项内容安全检查都有各自的适用场景和处理动作。防火墙如何处理流量，由所有内容安全检查的结果共同决定。

如果动作为 <span style="color:#FF0000">禁止</span> ，你还可以选择发送向服务端或客户端反馈报文，快速结束会话，减少系统资源消耗。

用户、终端设备、时间段、地址、地区、服务、应用、URL分类等匹配条件，以及内容安全检查所需的各种配置文件，在防火墙上都以对象的形式存在。你可以先创建对象，然后在多个安全策略中引用。

### NAT

#### SNAT（源NAT）

源NAT在NAT转换时，仅对报文中的源地址进行转换，主要应用于私网用户访问公网的场景。当私网用户主机访问Internet时，私网用户主机发送的报文到达NAT设备后，设备通过源NAT技术将报文中的私网IPv4地址转换成公网IPv4地址，从而使私网用户可以正常访问Internet。

##### SNAT（源NAT）

转换前

192\.168\.1\.11\-\-\-\->198\.18\.0\.27\(百度\)

转换后

106\.119\.207\.18（出口公网ip）\-\-\-\->198\.18\.0\.27（百度）

#### DNAT（目的NAT）

目的NAT在NAT转换时，仅对报文中的目的地址和目的端口号进行转换，主要应用于公网用户访问私网服务的场景。当公网用户主机发送的报文到达NAT设备后，设备通过目的NAT技术将报文中的公网IPv4地址转换成私网IPv4地址，从而使公网用户可以使用公网地址访问私网服务。

##### DNAT（目的NAT）

转换前

198\.18\.0\.27（百度）\-\-\-\->106\.119\.207\.18（出口公网ip）

转换后

198\.18\.0\.27（百度）\-\-\-\->192\.168\.1\.11（内网ip）

#### 双向NAT

双向NAT指的是在转换过程中同时转换报文的源信息和目的信息。 <span style="color:#FF0000">双向</span>  <span style="color:#FF0000">NAT</span>  <span style="color:#FF0000">不是一个单独的功能，而是源</span>  <span style="color:#FF0000">NAT</span>  <span style="color:#FF0000">和目的</span>  <span style="color:#FF0000">NAT</span>  <span style="color:#FF0000">的组合。</span> 双向NAT是针对同一条流，在其经过设备时同时转换报文的源地址和目的地址。双向NAT主要应用在同时有外网用户访问内部服务器和私网用户访问内部服务器的场景。

##### SNAT（源NAT）

转换前

192\.168\.1\.11\-\-\-\->198\.18\.0\.27\(百度\)

转换后

106\.119\.207\.18（出口公网ip）\-\-\-\->198\.18\.0\.27（百度）

##### DNAT（目的NAT）

转换前

198\.18\.0\.27（百度）\-\-\-\->106\.119\.207\.18（出口公网ip）

转换后

198\.18\.0\.27（百度）\-\-\-\->192\.168\.1\.11（内网ip）

## 03.部署模式

### 路由模式

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙8.png)

在路由模式中，防火墙的各个安全区域位于不同的网段且防火墙自身有 IP 地址。子网之间的相互访问控制被隔离。

### 透明模式

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙9.png)

透明模式即网桥模式，只区分内部网络和外部网络。不需要对防火墙进行 IP 设置，内网用户意识不到防火墙的存在，隐蔽性较好。降低了用户管理的复杂性。

### 混合模式

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙10.png)

混合模式顾名思义混合了路由模式和透明模式，这种防火墙在实际生活中应用比较广泛，在混合模式中，内网和服务器区域是透明模式，与外网间则是路由模式

### 旁路模式

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙11.png)

如果仅需要使用部分功能，例如IPS、防病毒、监控及网络行为控制等，既可以使防火墙工作在直路模式下，也可以工作在旁路模式下。

设备工作在旁路模式下时，仅对流量进行统计、扫描或者记录，并不对流量进行转发，同时，网络流量也不会受到设备本身故障的影响，所以，对于仅有审计需求的情况，使用旁路模式将会更加有效合理。

## 04.防火墙演示

### 深信服防火墙

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙12.png)

### 业务安全

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙13.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙14.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙15.png)

### 黑白名单

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙16.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙17.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙18.png)

### 策略

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙19.png)

### 新增策略

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙20.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙21.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙22.png)

### 对象

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙23.png)

### 网络

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙24.png)

## 05.m0n0防火墙

### m0n0防火墙介绍

https://m0n0.ch/wall/index.php

https://m0n0.ch/wall/downloads/physdiskwrite-0.5.3-PhysGUI-bundle.zip

```bash
physdiskwrite [-u] generic-pc-xxx.img
```

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙25.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙26.png)

### 环境配置

#### 网卡配置

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙27.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙28.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙29.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙30.png)

#### 网络拓扑

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙31.png)

##### 理论ip

```bash
#防火墙
内网ip：192.168.1.1
外网ip：172.1.1.5

#内网win10
内网ip：192.168.1.15

#外网win11
外网ip：172.1.1.15
```

##### 实验ip

> 仅主机：192.168.10.0/24
>
> NAT：192.168.70.0/24

```bash
#防火墙
内网ip：192.168.10.1
外网ip：192.168.70.5

#内网win10
内网ip：192.168.10.15

#外网win11
外网ip：192.168.70.17
```



#### 配置防火墙

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙32.png)

LAN配置为仅主机的网卡，对照mac地址找到对应的名称。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙33.png)

WAN配置为NAT模式的网卡，对照mac地址找到对应的名称。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙34.png)

选择2选项，配置LAN IP为192\.168\.1\.1

```bash
内网：192.168.1.1
```



#### 配置内网主机

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙35.png)

修改另外一台windows虚拟机和防火墙LAN同一个网卡

并手动配置IP为192\.168\.1\.5

**网关设为防火墙ip**

```bash
192.168.1.5
255.255.255.0
192.168.1.1
```



#### 防火墙后台页面配置

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙36.png)

打开浏览器输入设置的LAN口IP地址192\.168\.1\.1，输入用户名密码，进入防火墙网页配置界面。

> admin / mono

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙37.png)

#### 配置WAN口IP

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙38.png)

按照所选网卡的网段，手动配置WAN口IP地址172\.1\.1\.5

注意不要勾选阻止私有网络。

关闭windows防火墙。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙39.png)

#### 配置外网主机

修改另外一台虚拟机网卡为防火墙WAN口同一张，并设置IP地址为172\.1\.1\.15，作为外网主机

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙40.png)

#### 测试

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙41.png)

内网ping外网 能通

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙42.png)

外网ping内网 不通

### 默认规则

源地址 LAN子网 全部允许

从内网开始到所有都允许

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙43.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙44.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙45.png)

### 策略顺序

明明有拒绝内网到外网80端口的配置，可还是能够连接上。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙46.png)

防火墙策略**由上到下**过滤，需要将精细化的策略放在前边。

同样的策略，**将拒绝访问外网80端口策略**放在前面，策略生效，**内网已经不能连接外网80端口**了。

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙47.png)

#### 练习

如何通过修改策略关闭/打开通过**外网IP访问防火墙后台**？

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙48.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙49.png)



#### 答案

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙50.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙51.png)

### NAT

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙52.png)

#### NAT转入

使外网能够通过防火墙的外网`172.1.1.5:22`访问到内网主机`192.168.1.5:22`

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙53.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙54.png)

##### 抓包

抓包查看连接，连接的是172\.1\.1\.5防火墙外网IP，实际连接的是内网主机

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙55.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙56.png)

#### NAT转出

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙57.png)

#### 1:1

##### arp代理

让内网主机以自定义外网IP（172\.1\.1\.8需要设置arp代理）与外网进行通信

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙58.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙59.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙60.png)

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙61.png)

此时两个在外网主机（172\.1\.1\.15）上执行`arp -a` 有两个IP对应同一个mac地址

```bash
arp -a
```

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙62.png)

### m0n0防火墙练习

构建如图网络结构：

![](https://image.201068.xyz/assets/20.厂商防火墙/防火墙63.png)

#### 题目

1. 添加网卡并在之前的配置基础上**增加DMZ区域**。

2. 添加**NAT转换**将WAN（172\.1\.1\.5）的80端口转换到DMZ区（192\.168\.2\.5）的80端口。

3. DMZ区主机（192\.168\.2\.5）**只能够连接内网主机**（192\.168\.1\.5）`3306`端口

#### 配置

```bash
#防火墙
内网ip：192.168.10.1
外网ip：192.168.70.5
DMZ区ip：192.168.20.1

#内网win10
内网ip：192.168.10.15

#外网win11
外网ip：192.168.70.17

#DMZ区win11
DMZ区ip：192.168.20.15
```



#### 1.增加DMZ区域

##### 防火墙

> 192.168.20.1

![image-20241204135711981](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204135711981.png)

##### 规则

全放开

![image-20241204140726133](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204140726133.png)

![image-20241204140435035](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204140435035.png)

##### DMZ区win11

> 192.168.20.15

![image-20241204140415660](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204140415660.png)

#### 2.http

![image-20241204144149987](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204144149987.png)

![image-20241204144457726](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204144457726.png)

#### 3.sql

![image-20241204145058071](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204145058071.png)

#### 效果

##### http

![image-20241204151231323](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204151231323.png)

![image-20241204151210852](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204151210852.png)

##### sql

![image-20241204151259065](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204151259065.png)

![image-20241204150854831](https://image.201068.xyz/assets/20.厂商防火墙/image-20241204150854831.png)

## 深信服防火墙

攻击靶场，查看防火墙拦截的攻击事件

https://www.luanyu.cc/
